<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi Trực Tuyến - Anti Cheat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f3f4f6;
        }
        #video-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid #e53e3e;
            border-radius: 8px;
            background-color: #000;
            z-index: 1000;
        }
        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .fullscreen-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 24px;
        }
        .camera-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            font-size: 24px;
        }
        .hidden {
            display: none;
        }
        .question-block {
            transition: all 0.3s ease;
        }
        .question-block:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .timer {
            font-family: monospace;
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Camera Preview -->
    <div id="video-container">
        <video id="video-preview" autoplay muted playsinline></video>
    </div>

    <!-- Fullscreen Warning -->
    <div id="fullscreen-warning" class="fullscreen-warning hidden">
        <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
        <p class="text-center mb-6">Vui lòng vào chế độ toàn màn hình để tiếp tục làm bài</p>
        <button id="enter-fullscreen-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-expand mr-2"></i>Vào chế độ toàn màn hình
        </button>
    </div>

    <!-- Camera Warning -->
    <div id="camera-warning" class="camera-warning">
        <i class="fas fa-video text-indigo-500 text-5xl mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">Yêu cầu truy cập camera</h2>
        <p class="text-center mb-6 max-w-lg">Để đảm bảo tính công bằng, bạn cần cho phép truy cập camera trong suốt quá trình làm bài. Hệ thống sẽ phát hiện nếu bạn che camera hoặc có nhiều người trong khung hình.</p>
        <button id="start-camera-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-camera mr-2"></i>Bắt đầu kiểm tra
        </button>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Exam Code Input -->
        <div id="exam-code-section" class="bg-white shadow rounded-lg p-6 mb-8 text-center">
            <h1 class="text-2xl font-bold mb-4">Nhập mã dự thi</h1>
            <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-4">
                <input type="text" id="exam-code-input" placeholder="Nhập mã dự thi" class="px-4 py-2 border border-gray-300 rounded-md w-full md:w-64">
                <span class="text-gray-500">hoặc</span>
                <button id="scan-qr-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition">
                    <i class="fas fa-qrcode mr-2"></i>Quét mã QR
                </button>
            </div>
            <div id="qr-scan-container" class="mt-4 hidden">
                <div class="flex justify-center">
                    <video id="qr-video" width="300" height="200" class="border border-gray-300 rounded-md"></video>
                </div>
                <button id="stop-scan-btn" class="mt-2 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">
                    <i class="fas fa-stop mr-2"></i>Dừng quét
                </button>
            </div>
            <button id="start-exam-btn" class="mt-6 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition hidden">
                <i class="fas fa-play mr-2"></i>Bắt đầu làm bài
            </button>
        </div>

        <!-- Exam Info -->
        <div id="exam-info-section" class="bg-white shadow rounded-lg p-6 mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h1 id="exam-name" class="text-2xl font-bold"></h1>
                <div class="timer bg-gray-100 px-4 py-2 rounded-lg" id="exam-timer">00:00:00</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <span class="text-gray-600">Thời gian làm bài:</span>
                    <span id="exam-duration" class="font-medium ml-2"></span>
                </div>
                <div>
                    <span class="text-gray-600">Số câu hỏi:</span>
                    <span id="exam-questions-count" class="font-medium ml-2"></span>
                </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
                <p class="text-gray-600 mb-2">Lưu ý:</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Không được thoát khỏi chế độ toàn màn hình</li>
                    <li>Không được chuyển tab trình duyệt</li>
                    <li>Camera phải luôn bật và chỉ có 1 người trong khung hình</li>
                    <li>Vi phạm sẽ được ghi lại và thông báo cho người quản lý</li>
                </ul>
            </div>
        </div>

        <!-- Exam Questions -->
        <div id="exam-questions-section" class="hidden">
            <form id="exam-form">
                <div id="questions-container" class="space-y-6">
                    <!-- Questions will be loaded here -->
                </div>
                
                <div class="mt-8 bg-white shadow rounded-lg p-6">
                    <button type="submit" id="submit-exam-btn" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-paper-plane mr-2"></i>Nộp bài
                    </button>
                </div>
            </form>
        </div>

        <!-- Exam Completed -->
        <div id="exam-completed-section" class="bg-white shadow rounded-lg p-6 text-center hidden">
            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">Hoàn thành bài thi</h2>
            <p class="text-gray-600 mb-6">Bạn đã hoàn thành bài thi. Kết quả sẽ được thông báo sau khi giáo viên chấm điểm.</p>
            <button id="exit-exam-btn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                <i class="fas fa-sign-out-alt mr-2"></i>Thoát
            </button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHAxN6WCc2_8aB9t3NuWroespDR7Ry4QQ",
            authDomain: "anticheat-749d6.firebaseapp.com",
            projectId: "anticheat-749d6",
            storageBucket: "anticheat-749d6.firebasestorage.app",
            messagingSenderId: "417797975285",
            appId: "1:417797975285:web:71eadf4331ddb65968e9bc",
            measurementId: "G-4EDKFS0CY6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const examCodeInput = document.getElementById('exam-code-input');
        const scanQrBtn = document.getElementById('scan-qr-btn');
        const qrScanContainer = document.getElementById('qr-scan-container');
        const qrVideo = document.getElementById('qr-video');
        const stopScanBtn = document.getElementById('stop-scan-btn');
        const startExamBtn = document.getElementById('start-exam-btn');
        const examCodeSection = document.getElementById('exam-code-section');
        const examInfoSection = document.getElementById('exam-info-section');
        const examQuestionsSection = document.getElementById('exam-questions-section');
        const examCompletedSection = document.getElementById('exam-completed-section');
        const examForm = document.getElementById('exam-form');
        const questionsContainer = document.getElementById('questions-container');
        const submitExamBtn = document.getElementById('submit-exam-btn');
        const exitExamBtn = document.getElementById('exit-exam-btn');
        const examNameEl = document.getElementById('exam-name');
        const examDurationEl = document.getElementById('exam-duration');
        const examQuestionsCountEl = document.getElementById('exam-questions-count');
        const examTimerEl = document.getElementById('exam-timer');
        const fullscreenWarning = document.getElementById('fullscreen-warning');
        const enterFullscreenBtn = document.getElementById('enter-fullscreen-btn');
        const cameraWarning = document.getElementById('camera-warning');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const videoContainer = document.getElementById('video-container');
        const videoPreview = document.getElementById('video-preview');

        // Variables
        let currentExam = null;
        let examTimer = null;
        let timeLeft = 0;
        let examStartTime = null;
        let cameraStream = null;
        let faceDetectionInterval = null;
        let violationCount = 0;
        let qrScannerActive = false;
        let qrStream = null;

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Event listeners
        startExamBtn.addEventListener('click', startExam);
        scanQrBtn.addEventListener('click', startQRScan);
        stopScanBtn.addEventListener('click', stopQRScan);
        examForm.addEventListener('submit', submitExam);
        exitExamBtn.addEventListener('click', exitExam);
        enterFullscreenBtn.addEventListener('click', enterFullscreen);
        startCameraBtn.addEventListener('click', startCamera);

        // Check for fullscreen changes
        document.addEventListener('fullscreenchange', checkFullscreen);
        document.addEventListener('webkitfullscreenchange', checkFullscreen);
        document.addEventListener('mozfullscreenchange', checkFullscreen);
        document.addEventListener('MSFullscreenChange', checkFullscreen);

        // Check for visibility changes (tab switching)
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Start QR code scanning
        function startQRScan() {
            qrScanContainer.classList.remove('hidden');
            scanQrBtn.classList.add('hidden');
            qrScannerActive = true;
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
                .then(stream => {
                    qrStream = stream;
                    qrVideo.srcObject = stream;
                    qrVideo.play();
                    scanQRCode();
                })
                .catch(err => {
                    console.error("Error accessing camera for QR scan: ", err);
                    alert("Không thể truy cập camera để quét mã QR");
                    stopQRScan();
                });
        }

        // Stop QR code scanning
        function stopQRScan() {
            qrScannerActive = false;
            qrScanContainer.classList.add('hidden');
            scanQrBtn.classList.remove('hidden');
            
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
        }

        // Scan QR code from video stream
        function scanQRCode() {
            if (!qrScannerActive) return;
            
            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = qrVideo.videoWidth;
                canvas.height = qrVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    examCodeInput.value = code.data;
                    stopQRScan();
                    checkExamCode();
                }
            }
            
            if (qrScannerActive) {
                requestAnimationFrame(scanQRCode);
            }
        }

        // Check exam code when input changes
        examCodeInput.addEventListener('input', checkExamCode);

        // Check exam code validity
        function checkExamCode() {
            const code = examCodeInput.value.trim();
            
            if (code.length === 6) {
                db.collection('exams').where('code', '==', code).get()
                    .then(querySnapshot => {
                        if (!querySnapshot.empty) {
                            querySnapshot.forEach(doc => {
                                currentExam = {
                                    id: doc.id,
                                    ...doc.data()
                                };
                                startExamBtn.classList.remove('hidden');
                            });
                        } else {
                            startExamBtn.classList.add('hidden');
                            alert('Mã dự thi không hợp lệ');
                        }
                    })
                    .catch(error => {
                        console.error('Error checking exam code: ', error);
                        alert('Có lỗi xảy ra khi kiểm tra mã dự thi');
                    });
            } else {
                startExamBtn.classList.add('hidden');
            }
        }

        // Start exam
        function startExam() {
            if (!currentExam) return;
            
            examCodeSection.classList.add('hidden');
            examInfoSection.classList.remove('hidden');
            
            examNameEl.textContent = currentExam.name;
            examDurationEl.textContent = `${currentExam.time} phút`;
            examQuestionsCountEl.textContent = currentExam.questions.length;
            
            // Set timer
            timeLeft = currentExam.time * 60; // Convert to seconds
            examStartTime = new Date();
            updateTimer();
            examTimer = setInterval(updateTimer, 1000);
            
            // Load questions
            loadQuestions();
            
            // Show camera warning
            cameraWarning.classList.remove('hidden');
        }

        // Start camera and face detection
        function startCamera() {
            cameraWarning.classList.add('hidden');
            
            navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                .then(stream => {
                    cameraStream = stream;
                    videoPreview.srcObject = stream;
                    
                    // Start face detection
                    startFaceDetection();
                    
                    // Enter fullscreen mode
                    enterFullscreen();
                })
                .catch(err => {
                    console.error("Error accessing camera: ", err);
                    alert("Bạn phải cho phép truy cập camera để tiếp tục làm bài");
                    cameraWarning.classList.remove('hidden');
                });
        }

        // Start face detection (simplified - actual face detection would require a library like face-api.js)
        function startFaceDetection() {
            // In a real implementation, you would use a face detection library
            // This is a simplified version that just checks if the video is playing
            
            faceDetectionInterval = setInterval(() => {
                // Check if video is playing (simplified face detection)
                if (videoPreview.readyState >= 2) { // HAVE_CURRENT_DATA or more
                    // In a real app, you would analyze the video for faces here
                    // For demo purposes, we'll assume 1 face is detected
                    const facesDetected = 1; // Normally you'd get this from face detection
                    
                    if (facesDetected === 0) {
                        recordViolation('no_face', 'Không phát hiện khuôn mặt trong camera');
                    } else if (facesDetected > 1) {
                        recordViolation('multiple_faces', `Phát hiện ${facesDetected} khuôn mặt trong camera`);
                    }
                }
            }, 5000); // Check every 5 seconds
        }

        // Record violation
        function recordViolation(type, details) {
            violationCount++;
            
            // Take screenshot of video
            const canvas = document.createElement('canvas');
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
            const screenshot = canvas.toDataURL('image/jpeg', 0.7);
            
            // Save violation to Firestore
            db.collection('violations').add({
                examId: currentExam.id,
                studentId: auth.currentUser.uid,
                teacherId: currentExam.createdBy,
                type: type,
                details: details,
                screenshot: screenshot,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                console.log('Violation recorded:', type);
            })
            .catch(error => {
                console.error('Error recording violation: ', error);
            });
            
            // Show warning to user
            alert(`CẢNH BÁO VI PHẠM: ${details}`);
        }

        // Enter fullscreen mode
        function enterFullscreen() {
            if (!document.fullscreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
            }
        }

        // Check fullscreen status
        function checkFullscreen() {
            const isFullscreen = document.fullscreenElement || 
                               document.webkitFullscreenElement || 
                               document.msFullscreenElement;
            
            if (!isFullscreen && examQuestionsSection.classList.contains('hidden') === false) {
                fullscreenWarning.classList.remove('hidden');
                recordViolation('fullscreen_exit', 'Thí sinh thoát chế độ toàn màn hình');
            } else {
                fullscreenWarning.classList.add('hidden');
            }
        }

        // Handle visibility change (tab switching)
        function handleVisibilityChange() {
            if (document.hidden && examQuestionsSection.classList.contains('hidden') === false) {
                recordViolation('tab_switch', 'Thí sinh chuyển tab trình duyệt');
                alert('CẢNH BÁO: Bạn đã chuyển tab trình duyệt. Hành động này đã được ghi lại.');
            }
        }

        // Load questions
        function loadQuestions() {
            questionsContainer.innerHTML = '';
            
            currentExam.questions.forEach((question, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'question-block bg-white shadow rounded-lg p-6';
                
                if (question.type === 'mcq') {
                    questionEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                            <div class="space-y-2">
                                ${question.options.map((option, i) => `
                                    <label class="flex items-center">
                                        <input type="radio" name="q${index}" value="${i}" class="mr-2">
                                        ${option}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (question.type === 'tf') {
                    questionEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="q${index}" value="true" class="mr-2">
                                    Đúng
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q${index}" value="false" class="mr-2">
                                    Sai
                                </label>
                            </div>
                        </div>
                    `;
                } else if (question.type === 'sa') {
                    questionEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                            <input type="text" name="q${index}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    `;
                } else if (question.type === 'essay') {
                    questionEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                            <textarea name="q${index}" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="4"></textarea>
                        </div>
                    `;
                }
                
                questionsContainer.appendChild(questionEl);
            });
            
            examInfoSection.classList.add('hidden');
            examQuestionsSection.classList.remove('hidden');
        }

        // Update exam timer
        function updateTimer() {
            if (timeLeft <= 0) {
                clearInterval(examTimer);
                submitExam();
                return;
            }
            
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            
            examTimerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timeLeft--;
        }

        // Submit exam
        function submitExam(e) {
            if (e) e.preventDefault();
            
            clearInterval(examTimer);
            
            // Collect answers
            const answers = [];
            const formData = new FormData(examForm);
            
            currentExam.questions.forEach((question, index) => {
                const answer = formData.get(`q${index}`);
                answers.push(answer || '');
            });
            
            // Calculate time taken
            const timeTaken = currentExam.time * 60 - timeLeft;
            
            // Save exam results
            db.collection('exam_results').add({
                examId: currentExam.id,
                studentId: auth.currentUser.uid,
                teacherId: currentExam.createdBy,
                answers: answers,
                timeTaken: timeTaken,
                violations: violationCount,
                submittedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                examQuestionsSection.classList.add('hidden');
                examCompletedSection.classList.remove('hidden');
                
                // Stop camera and face detection
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                
                if (faceDetectionInterval) {
                    clearInterval(faceDetectionInterval);
                    faceDetectionInterval = null;
                }
                
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE11 */
                    document.msExitFullscreen();
                }
            })
            .catch(error => {
                console.error('Error submitting exam: ', error);
                alert('Có lỗi xảy ra khi nộp bài. Vui lòng thử lại.');
            });
        }

        // Exit exam
        function exitExam() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
