<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANTI CHEAT - Quản lý</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            font-family: 'Arial', sans-serif;
        }
        .hero-section {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23ffffff' fill-opacity='0.1' d='M0,128L48,117.3C96,107,192,85,288,112C384,139,480,213,576,218.7C672,224,768,160,864,138.7C960,117,1056,139,1152,149.3C1248,160,1344,160,1392,160L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            background-position: bottom;
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        .active-menu-item {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.2);
        }
        .mobile-menu {
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }
        .mobile-menu.open {
            max-height: 500px;
        }
        .feature-icon {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        .step-number {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-weight: bold;
            font-size: 1.25rem;
            color: white;
        }
        .nav-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #4f46e5;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .correct-answer {
            background-color: #dcfce7;
            border-left: 4px solid #22c55e;
        }
        .incorrect-answer {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        .pending-result {
            background-color: #fef9c3;
        }
        .graded-result {
            background-color: #dcfce7;
        }
        .ungraded-result {
            background-color: #fee2e2;
        }
        .correct-icon {
            color: #22c55e;
        }
        .incorrect-icon {
            color: #ef4444;
        }
        .answer-label {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
        }
        .correct-answer-label {
            background-color: #dcfce7;
        }
        .student-answer {
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .question-block {
            transition: all 0.3s ease;
        }
        .question-block:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .material-block {
            background-color: #f0f9ff;
            border-left: 4px solid #0ea5e9;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .student-photo {
            width: 150px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .export-btn {
            background-color: #10b981;
            color: white;
        }
        .export-btn:hover {
            background-color: #059669;
        }
        .tab-btn.active {
            border-bottom-color: #7c3aed;
            color: #7c3aed;
        }
        .loader {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .manual-input-mode .score-input {
            border-color: #4f46e5;
            background-color: #f5f3ff;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-gradient shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="home.html" class="flex items-center space-x-2">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt text-white text-xl"></i>
                        </div>
                        <span class="font-bold text-xl bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">ANTI CHEAT</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-1" id="desktop-menu">
                    <a href="home.html" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition">Trang chủ</a>
                    <a href="management.html" class="px-4 py-2 active-menu-item">Quản lý</a>
                    <a href="exam.html" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition">Thi trực tuyến</a>
                    <a href="#" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition" id="logout-link">Đăng xuất</a>
                </div>
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="p-2 focus:outline-none">
                        <i class="fas fa-bars text-gray-600 text-xl"></i>
                    </button>
                </div>
            </div>
            <!-- Mobile menu -->
            <div id="mobile-menu" class="mobile-menu md:hidden bg-white">
                <div class="px-2 pt-2 pb-3 space-y-1">
                    <a href="home.html" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition">Trang chủ</a>
                    <a href="management.html" class="block px-3 py-2 active-menu-item">Quản lý</a>
                    <a href="exam.html" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition">Thi trực tuyến</a>
                    <a href="#" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition" id="mobile-logout-link">Đăng xuất</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6 card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Tổng đề thi</p>
                        <p id="total-exams" class="text-2xl font-bold text-indigo-600">--</p>
                    </div>
                    <div class="bg-indigo-100 p-3 rounded-full">
                        <i class="fas fa-clipboard-list text-indigo-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Bài thi chờ chấm</p>
                        <p id="pending-exams" class="text-2xl font-bold text-yellow-600">--</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Vi phạm gần đây</p>
                        <p id="recent-violations" class="text-2xl font-bold text-red-600">--</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-lg p-1 shadow-sm">
            <button class="tab-btn py-2 px-4 font-medium text-sm border-b-2 border-indigo-600 text-indigo-600 active" data-tab="exams">
                Đề thi của tôi
            </button>
            <button class="tab-btn py-2 px-4 font-medium text-sm border-b-2 border-transparent text-gray-500" data-tab="results">
                Bài thi cần chấm
            </button>
            <button class="tab-btn py-2 px-4 font-medium text-sm border-b-2 border-transparent text-gray-500" data-tab="violations">
                Vi phạm
            </button>
        </div>

        <!-- Tab Content -->
        <div id="exams-tab" class="tab-content active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Danh sách đề thi</h2>
                <div>
                    <button id="export-excel-btn" class="export-btn px-4 py-2 rounded-lg hover:bg-green-700 transition mr-2">
                        <i class="fas fa-file-excel mr-2"></i>Xuất Excel
                    </button>
                    <button id="create-exam-btn" class="btn-primary px-4 py-2 rounded-lg font-medium">
                        <i class="fas fa-plus mr-2"></i>Tạo đề thi mới
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên đề thi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số câu hỏi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã dự thi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="exams-list" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Đang tải đề thi...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="results-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Bài thi cần chấm</h2>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thí sinh</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đề thi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày thi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điểm</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="results-list" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">Đang tải bài thi...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="violations-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Vi phạm của thí sinh</h2>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thí sinh</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đề thi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loại vi phạm</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="violations-list" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Đang tải vi phạm...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Exam Modal -->
    <div id="create-exam-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Tạo đề thi mới</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="exam-form">
                <div class="mb-4">
                    <label for="exam-name" class="block text-sm font-medium text-gray-700 mb-1">Tên đề thi</label>
                    <input type="text" id="exam-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="exam-time" class="block text-sm font-medium text-gray-700 mb-1">Thời gian làm bài (phút)</label>
                        <input type="number" id="exam-time" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="exam-code" class="block text-sm font-medium text-gray-700 mb-1">Mã đề thi (tự động)</label>
                        <input type="text" id="exam-code" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nội dung đề thi</label>
                    <div id="content-container" class="space-y-4">
                        <!-- Questions and materials will be added here -->
                    </div>
                    
                    <div class="mt-4 flex space-x-2 flex-wrap">
                        <button type="button" id="add-mcq" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 mb-2">
                            <i class="fas fa-list-ol mr-1"></i>Trắc nghiệm
                        </button>
                        <button type="button" id="add-tf" class="bg-green-100 text-green-700 px-3 py-1 rounded text-sm hover:bg-green-200 mb-2">
                            <i class="fas fa-check-circle mr-1"></i>Đúng/Sai
                        </button>
                        <button type="button" id="add-sa" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-sm hover:bg-yellow-200 mb-2">
                            <i class="fas fa-comment-alt mr-1"></i>Trả lời ngắn
                        </button>
                        <button type="button" id="add-essay" class="bg-purple-100 text-purple-700 px-3 py-1 rounded text-sm hover:bg-purple-200 mb-2">
                            <i class="fas fa-align-left mr-1"></i>Tự luận
                        </button>
                        <button type="button" id="add-material" class="bg-cyan-100 text-cyan-700 px-3 py-1 rounded text-sm hover:bg-cyan-200 mb-2">
                            <i class="fas fa-file-alt mr-1"></i>Tư liệu
                        </button>
                        <button type="button" id="import-text" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded text-sm hover:bg-indigo-200 mb-2">
                            <i class="fas fa-file-import mr-1"></i>Nhập từ văn bản
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-exam" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                        Hủy bỏ
                    </button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-md">
                        Lưu đề thi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Text Modal -->
    <div id="import-text-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Nhập đề thi từ văn bản</h3>
                <button id="close-import-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Dán nội dung đề thi</label>
                <textarea id="text-content" rows="10" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Dán nội dung đề thi ở đây. Mỗi câu hỏi trên một dòng, định dạng:
1. Câu hỏi trắc nghiệm?
A. Đáp án A
B. Đáp án B
C. Đáp án C
D. Đáp án D
Đáp án: A

2. Câu hỏi đúng/sai?
Đáp án: Đúng

3. Câu hỏi trả lời ngắn?
Đáp án: Nội dung trả lời

4. Đoạn văn với chỗ trống:
Are you ready to learn in a fun and easy way? Try SmartLearn – the app that makes studying (1)________ for everyone! SmartLearn helps students of all ages learn (2)________ and improve their grades.
Question 1: A. exciting			B. excited		C. excitingly  		D. excitement
Question 2: A. new brand skills					B. skills brand new 	
        C. new skills brand	 				D. brand new skills"></textarea>
                <p class="text-xs text-gray-500 mt-1">Hỗ trợ định dạng văn bản thuần túy. Sử dụng Gemini API để phân tích cấu trúc đề thi.</p>
            </div>
            
            <div id="import-status" class="mb-4 hidden">
                <div class="flex items-center">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>
                    <span>Đang xử lý văn bản...</span>
                </div>
            </div>
            
            <div id="import-error" class="mb-4 p-3 bg-red-100 text-red-700 rounded hidden"></div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-import" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                    Hủy bỏ
                </button>
                <button id="process-text" class="btn-primary px-4 py-2 rounded-md">
                    <i class="fas fa-cog mr-2"></i>Xử lý
                </button>
            </div>
        </div>
    </div>

    <!-- Exam Code Modal -->
    <div id="exam-code-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Mã dự thi</h3>
                <button id="close-code-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="text-center mb-4">
                <p class="mb-2">Đề thi: <span id="modal-exam-name" class="font-medium"></span></p>
                <p class="mb-4">Mã dự thi:</p>
                <div id="qrcode" class="flex justify-center mb-4"></div>
                <p id="modal-exam-code" class="font-bold text-xl mb-4 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent"></p>
                <p class="text-sm text-gray-600">Thí sinh có thể sử dụng mã này hoặc quét mã QR để tham gia thi</p>
            </div>
            
            <div class="flex justify-end">
                <button id="close-code-modal-btn" class="btn-primary px-4 py-2 rounded-md">
                    Đóng
                </button>
            </div>
        </div>
    </div>

    <!-- Exam Result Modal -->
    <div id="result-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent" id="result-modal-title">Chấm bài thi</h3>
                <button id="close-result-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p><strong>Thí sinh:</strong> <span id="result-student-name"></span></p>
                    <p><strong>Đề thi:</strong> <span id="result-exam-name"></span></p>
                    <p><strong>Ngày thi:</strong> <span id="result-exam-date"></span></p>
                </div>
                <div>
                    <p><strong>Thời gian làm bài:</strong> <span id="result-exam-duration"></span> giây</p>
                    <p><strong>Số lần vi phạm:</strong> <span id="result-violations"></span></p>
                    <p><strong>Điểm tự động:</strong> <span id="result-auto-score"></span></p>
                </div>
                <div class="flex justify-center">
                    <img id="result-student-photo" src="" alt="Ảnh thí sinh" class="student-photo">
                </div>
            </div>
            
            <div class="border-t border-b border-gray-200 py-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <p><strong>Tổng điểm:</strong></p>
                        <div class="flex items-center mt-1">
                            <input type="number" id="result-total-score-input" min="0" step="0.1" class="w-20 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <span class="ml-2">/ <span id="result-max-score">0</span></span>
                        </div>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="manual-scoring-mode" class="mr-2">
                            <span>Chế độ nhập điểm thủ công</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div id="result-questions-container" class="space-y-6 max-h-96 overflow-y-auto mb-4">
                <!-- Questions will be loaded here -->
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="save-result" class="btn-primary px-4 py-2 rounded-md">
                    Lưu kết quả
                </button>
                <button id="cancel-result" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                    Hủy bỏ
                </button>
            </div>
        </div>
    </div>

    <!-- Violation Detail Modal -->
    <div id="violation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Chi tiết vi phạm</h3>
                <button id="close-violation-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="violation-details">
                <!-- Violation details will be loaded here -->
            </div>
            
            <div class="flex justify-end mt-4">
                <button id="close-violation-modal-btn" class="btn-primary px-4 py-2 rounded-md">
                    Đóng
                </button>
            </div>
        </div>
    </div>

    <!-- Export Exam Modal -->
    <div id="export-exam-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Xuất kết quả ra Excel</h3>
                <button id="close-export-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label for="export-exam-select" class="block text-sm font-medium text-gray-700 mb-2">Chọn đề thi</label>
                <select id="export-exam-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">-- Chọn đề thi --</option>
                </select>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-export" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                    Hủy bỏ
                </button>
                <button id="confirm-export" class="export-btn px-4 py-2 rounded-md">
                    <i class="fas fa-file-excel mr-2"></i>Xuất Excel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHAxN6WCc2_8aB9t3NuWroespDR7Ry4QQ",
            authDomain: "anticheat-749d6.firebaseapp.com",
            projectId: "anticheat-749d6",
            storageBucket: "anticheat-749d6.appspot.com",
            messagingSenderId: "417797975285",
            appId: "1:417797975285:web:71eadf4331ddb65968e9bc",
            measurementId: "G-4EDKFS0CY6"
        };

        // Gemini API configuration
        const GEMINI_CONFIG = {
            apiKey: 'AIzaSyAQMglgiKEHY8XznNf9ZIdjYMnKgH9DhJg',
            model: 'gemini-2.0-flash-thinking-exp-01-21'
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const examsList = document.getElementById('exams-list');
        const resultsList = document.getElementById('results-list');
        const violationsList = document.getElementById('violations-list');
        const totalExams = document.getElementById('total-exams');
        const pendingExams = document.getElementById('pending-exams');
        const recentViolations = document.getElementById('recent-violations');
        const resultModal = document.getElementById('result-modal');
        const closeResultModal = document.getElementById('close-result-modal');
        const resultQuestionsContainer = document.getElementById('result-questions-container');
        const saveResultBtn = document.getElementById('save-result');
        const cancelResultBtn = document.getElementById('cancel-result');
        const violationModal = document.getElementById('violation-modal');
        const closeViolationModal = document.getElementById('close-violation-modal');
        const closeViolationModalBtn = document.getElementById('close-violation-modal-btn');
        const violationDetails = document.getElementById('violation-details');
        const resultStudentPhoto = document.getElementById('result-student-photo');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportExamModal = document.getElementById('export-exam-modal');
        const closeExportModal = document.getElementById('close-export-modal');
        const cancelExport = document.getElementById('cancel-export');
        const confirmExport = document.getElementById('confirm-export');
        const exportExamSelect = document.getElementById('export-exam-select');
        const resultTotalScoreInput = document.getElementById('result-total-score-input');
        const manualScoringMode = document.getElementById('manual-scoring-mode');
        
        // Create exam modal elements
        const createExamBtn = document.getElementById('create-exam-btn');
        const createExamModal = document.getElementById('create-exam-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const cancelExamBtn = document.getElementById('cancel-exam');
        const examForm = document.getElementById('exam-form');
        const contentContainer = document.getElementById('content-container');
        const addMcqBtn = document.getElementById('add-mcq');
        const addTfBtn = document.getElementById('add-tf');
        const addSaBtn = document.getElementById('add-sa');
        const addEssayBtn = document.getElementById('add-essay');
        const addMaterialBtn = document.getElementById('add-material');
        const examCodeModal = document.getElementById('exam-code-modal');
        const closeCodeModalBtn = document.getElementById('close-code-modal');
        const closeCodeModalBtn2 = document.getElementById('close-code-modal-btn');
        const modalExamName = document.getElementById('modal-exam-name');
        const modalExamCode = document.getElementById('modal-exam-code');
        const qrcodeDiv = document.getElementById('qrcode');

        // Text import elements
        const importTextBtn = document.getElementById('import-text');
        const importTextModal = document.getElementById('import-text-modal');
        const closeImportModalBtn = document.getElementById('close-import-modal');
        const cancelImportBtn = document.getElementById('cancel-import');
        const processTextBtn = document.getElementById('process-text');
        const textContentInput = document.getElementById('text-content');
        const importStatus = document.getElementById('import-status');
        const importError = document.getElementById('import-error');

        // Current user and exam data
        let currentUser = null;
        let currentExamResult = null;
        let currentExamData = null;
        let currentResultId = null;
        let itemCount = 0;
        let examListData = [];

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadStatistics();
                loadExams();
                loadResults();
                loadViolations();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Mobile menu toggle
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('open');
        });

        // Logout
        document.getElementById('logout-link').addEventListener('click', logout);
        document.getElementById('mobile-logout-link').addEventListener('click', logout);

        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            });
        }

        // Tab switching
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                
                // Update active tab button
                tabBtns.forEach(tb => {
                    tb.classList.remove('border-indigo-600', 'text-indigo-600', 'active');
                    tb.classList.add('border-transparent', 'text-gray-500');
                });
                btn.classList.add('border-indigo-600', 'text-indigo-600', 'active');
                btn.classList.remove('border-transparent', 'text-gray-500');
                
                // Show active tab content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });

        // Show create exam modal
        createExamBtn.addEventListener('click', () => {
            // Generate exam code
            const examCode = generateExamCode();
            document.getElementById('exam-code').value = examCode;
            
            // Clear previous content
            contentContainer.innerHTML = '';
            itemCount = 0;
            
            createExamModal.classList.remove('hidden');
        });

        // Close create exam modal
        closeModalBtn.addEventListener('click', () => {
            createExamModal.classList.add('hidden');
        });

        cancelExamBtn.addEventListener('click', () => {
            createExamModal.classList.add('hidden');
        });

        // Add content types
        addMcqBtn.addEventListener('click', () => addContentItem('mcq'));
        addTfBtn.addEventListener('click', () => addContentItem('tf'));
        addSaBtn.addEventListener('click', () => addContentItem('sa'));
        addEssayBtn.addEventListener('click', () => addContentItem('essay'));
        addMaterialBtn.addEventListener('click', () => addContentItem('material'));

        // Text import functionality
        importTextBtn.addEventListener('click', () => {
            importTextModal.classList.remove('hidden');
        });

        closeImportModalBtn.addEventListener('click', () => {
            importTextModal.classList.add('hidden');
        });

        cancelImportBtn.addEventListener('click', () => {
            importTextModal.classList.add('hidden');
        });

        processTextBtn.addEventListener('click', processTextContent);

        // Submit exam form
        examForm.addEventListener('submit', e => {
            e.preventDefault();
            
            const examName = document.getElementById('exam-name').value;
            const examTime = parseInt(document.getElementById('exam-time').value);
            const examCode = document.getElementById('exam-code').value;
            
            // Collect content items
            const contentItems = [];
            const contentBlocks = contentContainer.querySelectorAll('.content-block');
            
            contentBlocks.forEach(block => {
                const type = block.getAttribute('data-type');
                
                if (type === 'mcq') {
                    const question = block.querySelector('.question-text').value;
                    const options = [];
                    const optionInputs = block.querySelectorAll('.option-input');
                    const correctOption = block.querySelector('input[name="correct-option"]:checked').value;
                    
                    optionInputs.forEach(input => {
                        options.push(input.value);
                    });
                    
                    contentItems.push({
                        type,
                        question,
                        options,
                        correctOption: correctOption.toString()
                    });
                } else if (type === 'tf') {
                    const question = block.querySelector('.question-text').value;
                    const correctAnswer = block.querySelector('input[name="tf-answer"]:checked').value;
                    
                    contentItems.push({
                        type,
                        question,
                        correctAnswer
                    });
                } else if (type === 'sa') {
                    const question = block.querySelector('.question-text').value;
                    const correctAnswer = block.querySelector('.sa-answer').value;
                    
                    contentItems.push({
                        type,
                        question,
                        correctAnswer
                    });
                } else if (type === 'essay') {
                    const question = block.querySelector('.question-text').value;
                    
                    contentItems.push({
                        type,
                        question
                    });
                } else if (type === 'material') {
                    const content = block.querySelector('.material-content').value;
                    
                    contentItems.push({
                        type,
                        content
                    });
                }
            });
            
            if (contentItems.filter(item => item.type !== 'material').length === 0) {
                alert('Vui lòng thêm ít nhất một câu hỏi');
                return;
            }
            
            // Save exam to Firestore
            db.collection('exams').add({
                name: examName,
                time: examTime,
                code: examCode,
                content: contentItems,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(docRef => {
                console.log('Exam saved with ID: ', docRef.id);
                createExamModal.classList.add('hidden');
                examForm.reset();
                
                // Show exam code modal
                modalExamName.textContent = examName;
                modalExamCode.textContent = examCode;
                
                // Generate QR code
                qrcodeDiv.innerHTML = '';
                QRCode.toCanvas(qrcodeDiv, examCode, { 
                    width: 200,
                    errorCorrectionLevel: 'H', // High error correction
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                }, (error) => {
                    if (error) console.error(error);
                });
                
                examCodeModal.classList.remove('hidden');
                
                // Reload exams list and statistics
                loadExams();
                loadStatistics();
            })
            .catch(error => {
                console.error('Error saving exam: ', error);
                alert('Có lỗi xảy ra khi lưu đề thi');
            });
        });

        // Close exam code modal
        closeCodeModalBtn.addEventListener('click', () => {
            examCodeModal.classList.add('hidden');
        });

        closeCodeModalBtn2.addEventListener('click', () => {
            examCodeModal.classList.add('hidden');
        });

        // Load statistics
        function loadStatistics() {
            // Total exams
            db.collection('exams')
                .where('createdBy', '==', currentUser.uid)
                .get()
                .then(querySnapshot => {
                    totalExams.textContent = querySnapshot.size;
                });
            
            // Pending exams
            db.collection('exam_results')
                .where('teacherId', '==', currentUser.uid)
                .where('status', '==', 'pending')
                .get()
                .then(querySnapshot => {
                    pendingExams.textContent = querySnapshot.size;
                });
            
            // Recent violations (last 7 days)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            db.collection('violations')
                .where('teacherId', '==', currentUser.uid)
                .where('timestamp', '>=', sevenDaysAgo)
                .get()
                .then(querySnapshot => {
                    recentViolations.textContent = querySnapshot.size;
                });
        }

        // Load exams
        function loadExams() {
            examsList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Đang tải đề thi...</td></tr>';
            
            db.collection('exams')
                .where('createdBy', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        examsList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Bạn chưa có đề thi nào</td></tr>';
                        return;
                    }
                    
                    examsList.innerHTML = '';
                    examListData = [];
                    
                    querySnapshot.forEach(doc => {
                        const exam = doc.data();
                        const examId = doc.id;
                        examListData.push({ id: examId, ...exam });
                        
                        // Count questions (excluding materials)
                        const questionCount = exam.content.filter(item => item.type !== 'material').length;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-medium text-gray-900">${exam.name}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-900">${exam.time} phút</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-900">${questionCount}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-gray-900 font-mono">${exam.code}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 view-exam" data-id="${examId}">Xem</button>
                                <button class="text-red-600 hover:text-red-900 ml-2 delete-exam" data-id="${examId}">Xóa</button>
                            </td>
                        `;
                        
                        examsList.appendChild(row);
                    });
                    
                    // Add event listeners to view and delete buttons
                    document.querySelectorAll('.view-exam').forEach(btn => {
                        btn.addEventListener('click', e => {
                            const examId = e.target.getAttribute('data-id');
                            viewExam(examId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-exam').forEach(btn => {
                        btn.addEventListener('click', e => {
                            const examId = e.target.getAttribute('data-id');
                            if (confirm('Bạn có chắc muốn xóa đề thi này?')) {
                                deleteExam(examId);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading exams:', error);
                    examsList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Có lỗi xảy ra khi tải đề thi</td></tr>';
                });
        }

        // Load results
        function loadResults() {
            resultsList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Đang tải bài thi...</td></tr>';
            
            db.collection('exam_results')
                .where('teacherId', '==', currentUser.uid)
                .orderBy('submittedAt', 'desc')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        resultsList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Không có bài thi nào</td></tr>';
                        return;
                    }
                    
                    resultsList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const result = doc.data();
                        const resultId = doc.id;
                        
                        // Get student name
                        db.collection('users').doc(result.studentId).get()
                            .then(studentDoc => {
                                const studentName = studentDoc.exists ? studentDoc.data().name : 'Không xác định';
                                
                                // Get exam name
                                db.collection('exams').doc(result.examId).get()
                                    .then(examDoc => {
                                        const examName = examDoc.exists ? examDoc.data().name : 'Đề thi đã bị xóa';
                                        const totalQuestions = examDoc.exists ? examDoc.data().content.filter(item => item.type !== 'material').length : 0;
                                        
                                        const row = document.createElement('tr');
                                        
                                        // Determine row class based on status
                                        if (result.status === 'pending') {
                                            row.className = 'pending-result';
                                        } else if (result.status === 'graded') {
                                            row.className = 'graded-result';
                                        } else {
                                            // Check if there are essay questions that need grading
                                            const hasEssayQuestions = examDoc.exists && 
                                                examDoc.data().content.some(q => q.type === 'essay');
                                            const hasUngradedEssay = hasEssayQuestions && 
                                                result.answers.some((a, i) => 
                                                    examDoc.data().content[i].type === 'essay' && 
                                                    (a.manualScore === null || a.manualScore === undefined)
                                                );
                                            
                                            if (hasUngradedEssay) {
                                                row.className = 'ungraded-result';
                                            } else {
                                                row.className = result.status === 'pending' ? 'pending-result' : 'graded-result';
                                            }
                                        }
                                        
                                        row.innerHTML = `
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="font-medium text-gray-900">${studentName}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-gray-900">${examName}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-gray-900">${result.submittedAt.toDate().toLocaleString()}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-gray-900">${result.finalScore || result.score || 0}/${totalQuestions}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-gray-900">${getResultStatus(result, examDoc.data())}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button class="text-indigo-600 hover:text-indigo-900 grade-exam" data-id="${resultId}">Xem/Chấm</button>
                                            </td>
                                        `;
                                        
                                        resultsList.appendChild(row);
                                        
                                        // Add event listener
                                        row.querySelector('.grade-exam').addEventListener('click', e => {
                                            const resultId = e.target.getAttribute('data-id');
                                            gradeExam(resultId);
                                        });
                                    });
                            });
                    });
                })
                .catch(error => {
                    console.error('Error loading results:', error);
                    resultsList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Có lỗi xảy ra khi tải bài thi</td></tr>';
                });
        }

        // Load violations
        function loadViolations() {
            violationsList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Đang tải vi phạm...</td></tr>';
            
            db.collection('violations')
                .where('teacherId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        violationsList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Không có vi phạm nào</td></tr>';
                        return;
                    }
                    
                    violationsList.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const violation = doc.data();
                        const violationId = doc.id;
                        
                        // Get student name
                        db.collection('users').doc(violation.studentId).get()
                            .then(studentDoc => {
                                const studentName = studentDoc.exists ? studentDoc.data().name : 'Không xác định';
                                
                                // Get exam name
                                db.collection('exams').doc(violation.examId).get()
                                    .then(examDoc => {
                                        const examName = examDoc.exists ? examDoc.data().name : 'Đề thi đã bị xóa';
                                        
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="font-medium text-gray-900">${studentName}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-gray-900">${examName}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-gray-900">${getViolationType(violation.type)}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="text-gray-900">${violation.timestamp.toDate().toLocaleString()}</div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button class="text-indigo-600 hover:text-indigo-900 view-violation" data-id="${violationId}">Xem</button>
                                            </td>
                                        `;
                                        
                                        violationsList.appendChild(row);
                                        
                                        // Add event listener
                                        row.querySelector('.view-violation').addEventListener('click', e => {
                                            const violationId = e.target.getAttribute('data-id');
                                            viewViolation(violationId);
                                        });
                                    });
                            });
                    });
                })
                .catch(error => {
                    console.error('Error loading violations:', error);
                    violationsList.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Có lỗi xảy ra khi tải vi phạm</td></tr>';
                });
        }

        // Get result status text
        function getResultStatus(result, examData) {
            if (result.status === 'pending') return 'Chờ chấm';
            if (result.status === 'graded') return 'Đã chấm';
            
            // Check for ungraded essay questions
            if (examData && examData.content) {
                const hasUngradedEssay = examData.content.some((q, i) => 
                    q.type === 'essay' && 
                    (result.answers[i]?.manualScore === null || result.answers[i]?.manualScore === undefined)
                );
                
                if (hasUngradedEssay) return 'Chưa chấm tự luận';
            }
            
            return 'Đã chấm';
        }

        // View exam
        function viewExam(examId) {
            db.collection('exams').doc(examId).get()
                .then(doc => {
                    if (doc.exists) {
                        const exam = doc.data();
                        const questionCount = exam.content.filter(item => item.type !== 'material').length;
                        alert(`Xem chi tiết đề thi: ${exam.name}\nThời gian: ${exam.time} phút\nSố câu hỏi: ${questionCount}\nMã dự thi: ${exam.code}`);
                    } else {
                        alert('Đề thi không tồn tại');
                    }
                })
                .catch(error => {
                    console.error('Error viewing exam:', error);
                    alert('Có lỗi xảy ra khi xem đề thi');
                });
        }

        // View exam result
        function viewExamResult(resultId) {
            db.collection('exam_results').doc(resultId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('Kết quả bài thi không tồn tại');
                        return;
                    }
                    
                    const result = doc.data();
                    currentExamResult = result;
                    
                    // Get exam data
                    db.collection('exams').doc(result.examId).get()
                        .then(examDoc => {
                            if (!examDoc.exists) {
                                alert('Đề thi không tồn tại');
                                return;
                            }
                            
                            currentExamData = examDoc.data();
                            
                            // Get student name
                            db.collection('users').doc(result.studentId).get()
                                .then(studentDoc => {
                                    const studentName = studentDoc.exists ? studentDoc.data().name : 'Không xác định';
                                    
                                    // Calculate total score (auto score + manual scores for essays)
                                    let totalScore = result.score || 0; // Start with auto score
                                    if (result.answers) {
                                        currentExamData.content.forEach((q, i) => {
                                            if (q.type === 'essay') {
                                                totalScore += result.answers[i]?.manualScore || 0;
                                            }
                                        });
                                    }
                                    
                                    // Update modal info
                                    document.getElementById('result-modal-title').textContent = `Kết quả bài thi: ${currentExamData.name}`;
                                    document.getElementById('result-student-name').textContent = studentName;
                                    document.getElementById('result-exam-name').textContent = currentExamData.name;
                                    document.getElementById('result-exam-date').textContent = result.submittedAt.toDate().toLocaleString();
                                    document.getElementById('result-exam-duration').textContent = result.timeTaken || 'N/A';
                                    document.getElementById('result-violations').textContent = result.violations || 0;
                                    document.getElementById('result-auto-score').textContent = `${result.score || 0}/${currentExamData.content.filter(item => item.type !== 'material').length}`;
                                    document.getElementById('result-total-score').textContent = totalScore;
                                    document.getElementById('result-max-score').textContent = currentExamData.content.filter(item => item.type !== 'material').length;
                                    
                                    // Show student photo if available
                                    if (result.studentPhoto) {
                                        resultStudentPhoto.src = result.studentPhoto;
                                        resultStudentPhoto.style.display = 'block';
                                    } else {
                                        resultStudentPhoto.style.display = 'none';
                                    }
                                    
                                    // Load content
                                    resultQuestionsContainer.innerHTML = '';
                                    
                                    currentExamData.content.forEach((item, index) => {
                                        if (item.type === 'material') {
                                            const materialElement = document.createElement('div');
                                            materialElement.className = 'material-block p-4 rounded-lg border border-gray-200 mb-4';
                                            materialElement.innerHTML = `
                                                <div class="mb-4">
                                                    <h3 class="text-lg font-medium mb-2">Tư liệu</h3>
                                                    <p class="whitespace-pre-line">${item.content}</p>
                                                </div>
                                            `;
                                            resultQuestionsContainer.appendChild(materialElement);
                                        } else {
                                            const question = item;
                                            const questionElement = document.createElement('div');
                                            const studentAnswer = result.answers[index]?.answer || '';
                                            const isCorrect = checkAnswerCorrect(question, studentAnswer);
                                            
                                            // Remove background color for essay questions
                                            questionElement.className = `question-block p-4 rounded-lg border border-gray-200 mb-4 ${
                                                question.type !== 'essay' ? (isCorrect ? 'correct-answer' : 'incorrect-answer') : ''
                                            }`;
                                            
                                            let questionHtml = '';
                                            
                                            if (question.type === 'mcq') {
                                                questionHtml = `
                                                    <div class="mb-4">
                                                        <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                                                        <div class="space-y-2 mb-3">
                                                            ${question.options.map((option, i) => {
                                                                const isStudentAnswer = String(studentAnswer) === String(i); // So sánh dạng string
                                                                const isCorrectOption = String(question.correctOption) === String(i); // So sánh dạng string
                                                                return `
                                                                    <div class="answer-label ${isCorrectOption ? 'correct-answer-label' : ''}">
                                                                        <span class="mr-2">${String.fromCharCode(65 + i)}.</span>
                                                                        <span class="flex-grow">${option}</span>
                                                                        ${isStudentAnswer ? 
                                                                            `<span class="student-answer ml-2">(Đáp án HS)</span>` : ''}
                                                                        ${isStudentAnswer && !isCorrectOption ? 
                                                                            `<i class="fas fa-times incorrect-icon ml-2"></i>` : ''}
                                                                    </div>
                                                                `;
                                                            }).join('')}
                                                        </div>
                                                        <div class="text-sm text-gray-600">
                                                            <strong>Đáp án đúng:</strong> ${String.fromCharCode(65 + parseInt(question.correctOption))}. ${question.options[question.correctOption]}
                                                        </div>
                                                        <div class="mt-2 text-sm font-medium">
                                                            Điểm: ${isCorrect ? '1' : '0'}/1
                                                        </div>
                                                    </div>
                                                `;
                                            } else if (question.type === 'tf') {
                                                const correctAnswerText = question.correctAnswer === 'true' ? 'Đúng' : 'Sai';
                                                const studentAnswerText = studentAnswer === 'true' ? 'Đúng' : 'Sai';
                                                
                                                questionHtml = `
                                                    <div class="mb-4">
                                                        <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                                                        <div class="space-y-2 mb-3">
                                                            <div class="answer-label ${question.correctAnswer === 'true' ? 'correct-answer-label' : ''}">
                                                                <span>Đúng</span>
                                                                ${studentAnswer === 'true' ? 
                                                                    `<span class="student-answer ml-2">(Đáp án HS)</span>` : ''}
                                                                ${studentAnswer === 'true' && question.correctAnswer !== 'true' ? 
                                                                    `<i class="fas fa-times incorrect-icon ml-2"></i>` : ''}
                                                            </div>
                                                            <div class="answer-label ${question.correctAnswer === 'false' ? 'correct-answer-label' : ''}">
                                                                <span>Sai</span>
                                                                ${studentAnswer === 'false' ? 
                                                                    `<span class="student-answer ml-2">(Đáp án HS)</span>` : ''}
                                                                ${studentAnswer === 'false' && question.correctAnswer !== 'false' ? 
                                                                    `<i class="fas fa-times incorrect-icon ml-2"></i>` : ''}
                                                            </div>
                                                        </div>
                                                        <div class="text-sm text-gray-600">
                                                            <strong>Đáp án đúng:</strong> ${correctAnswerText}
                                                        </div>
                                                        <div class="mt-2 text-sm font-medium">
                                                            Điểm: ${isCorrect ? '1' : '0'}/1
                                                        </div>
                                                    </div>
                                                `;
                                            } else if (question.type === 'sa') {
                                                questionHtml = `
                                                    <div class="mb-4">
                                                        <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                                                        <div class="mb-3">
                                                            <p class="font-bold">Trả lời của thí sinh:</p>
                                                            <p class="bg-white p-2 border border-gray-300 rounded">${studentAnswer || 'Không trả lời'}</p>
                                                        </div>
                                                        <div class="text-sm text-gray-600">
                                                            <strong>Đáp án đúng:</strong> ${question.correctAnswer}
                                                        </div>
                                                        ${!isCorrect ? 
                                                            `<i class="fas fa-times incorrect-icon mt-2"></i>` : ''
                                                        }
                                                        <div class="mt-2 text-sm font-medium">
                                                            Điểm: ${isCorrect ? '1' : '0'}/1
                                                        </div>
                                                    </div>
                                                `;
                                            } else if (question.type === 'essay') {
                                                const manualScore = result.answers[index]?.manualScore || 0;
                                                questionHtml = `
                                                    <div class="mb-4">
                                                        <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                                                        <div class="mb-3">
                                                            <p class="font-bold">Trả lời của thí sinh:</p>
                                                            <p class="bg-white p-2 border border-gray-300 rounded whitespace-pre-line">${studentAnswer || 'Không trả lời'}</p>
                                                        </div>
                                                        <div class="flex items-center mb-2">
                                                            <label class="mr-3">Điểm:</label>
                                                            <input type="number" min="0" max="1" step="0.5" value="${manualScore}" 
                                                                class="score-input border border-gray-300 rounded px-2 py-1 w-16" data-index="${index}" disabled>
                                                            <span class="ml-2">/ 1</span>
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                            
                                            questionElement.innerHTML = questionHtml;
                                            resultQuestionsContainer.appendChild(questionElement);
                                        }
                                    });
                                    
                                    // Disable save button for viewing
                                    saveResultBtn.disabled = true;
                                    
                                    // Show modal
                                    resultModal.classList.remove('hidden');
                                });
                        });
                })
                .catch(error => {
                    console.error('Error loading exam result:', error);
                    alert('Có lỗi xảy ra khi xem kết quả bài thi');
                });
        }

        // Grade exam
        function gradeExam(resultId) {
            currentResultId = resultId;
            
            db.collection('exam_results').doc(resultId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('Bài thi không tồn tại');
                        return;
                    }
                    
                    const result = doc.data();
                    currentExamResult = result;
                    
                    // Get exam data
                    db.collection('exams').doc(result.examId).get()
                        .then(examDoc => {
                            if (!examDoc.exists) {
                                alert('Đề thi không tồn tại');
                                return;
                            }
                            
                            currentExamData = examDoc.data();
                            
                            // Get student name
                            db.collection('users').doc(result.studentId).get()
                                .then(studentDoc => {
                                    const studentName = studentDoc.exists ? studentDoc.data().name : 'Không xác định';
                                    
                                    // Update modal info
                                    document.getElementById('result-modal-title').textContent = `Chấm bài thi: ${currentExamData.name}`;
                                    document.getElementById('result-student-name').textContent = studentName;
                                    document.getElementById('result-exam-name').textContent = currentExamData.name;
                                    document.getElementById('result-exam-date').textContent = result.submittedAt.toDate().toLocaleString();
                                    document.getElementById('result-exam-duration').textContent = result.timeTaken || 'N/A';
                                    document.getElementById('result-violations').textContent = result.violations || 0;
                                    document.getElementById('result-auto-score').textContent = `${result.score || 0}/${currentExamData.content.filter(item => item.type !== 'material').length}`;
                                    document.getElementById('result-max-score').textContent = currentExamData.content.filter(item => item.type !== 'material').length;
                                    
                                    // Set total score input
                                    resultTotalScoreInput.value = result.finalScore || result.score || 0;
                                    resultTotalScoreInput.max = currentExamData.content.filter(item => item.type !== 'material').length;
                                    
                                    // Show student photo if available
                                    if (result.studentPhoto) {
                                        resultStudentPhoto.src = result.studentPhoto;
                                        resultStudentPhoto.style.display = 'block';
                                    } else {
                                        resultStudentPhoto.style.display = 'none';
                                    }
                                    
                                    // Load content
                                    resultQuestionsContainer.innerHTML = '';
                                    
                                    currentExamData.content.forEach((item, index) => {
                                        if (item.type === 'material') {
                                            const materialElement = document.createElement('div');
                                            materialElement.className = 'material-block p-4 rounded-lg border border-gray-200 mb-4';
                                            materialElement.innerHTML = `
                                                <div class="mb-4">
                                                    <h3 class="text-lg font-medium mb-2">Tư liệu</h3>
                                                    <p class="whitespace-pre-line">${item.content}</p>
                                                </div>
                                            `;
                                            resultQuestionsContainer.appendChild(materialElement);
                                        } else {
                                            const question = item;
                                            const questionElement = document.createElement('div');
                                            const studentAnswer = result.answers[index]?.answer || '';
                                            const isCorrect = checkAnswerCorrect(question, studentAnswer);
                                            
                                            // Remove background color for essay questions
                                            questionElement.className = `question-block p-4 rounded-lg border border-gray-200 mb-4 ${
                                                question.type !== 'essay' ? (isCorrect ? 'correct-answer' : 'incorrect-answer') : ''
                                            }`;
                                            
                                            let questionHtml = '';
                                            
                                            if (question.type === 'mcq') {
                                                questionHtml = `
                                                    <div class="mb-4">
                                                        <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                                                        <div class="space-y-2 mb-3">
                                                            ${question.options.map((option, i) => {
                                                                const isStudentAnswer = String(studentAnswer) === String(i); // So sánh dạng string
                                                                const isCorrectOption = String(question.correctOption) === String(i); // So sánh dạng string
                                                                return `
                                                                    <div class="answer-label ${isCorrectOption ? 'correct-answer-label' : ''}">
                                                                        <span class="mr-2">${String.fromCharCode(65 + i)}.</span>
                                                                        <span class="flex-grow">${option}</span>
                                                                        ${isStudentAnswer ? 
                                                                            `<span class="student-answer ml-2">(Đáp án HS)</span>` : ''}
                                                                        ${isStudentAnswer && !isCorrectOption ? 
                                                                            `<i class="fas fa-times incorrect-icon ml-2"></i>` : ''}
                                                                    </div>
                                                                `;
                                                            }).join('')}
                                                        </div>
                                                        <div class="text-sm text-gray-600">
                                                            <strong>Đáp án đúng:</strong> ${String.fromCharCode(65 + parseInt(question.correctOption))}. ${question.options[question.correctOption]}
                                                        </div>
                                                        <div class="mt-2 text-sm font-medium">
                                                            Điểm: ${isCorrect ? '1' : '0'}/1
                                                        </div>
                                                    </div>
                                                `;
                                            } else if (question.type === 'tf') {
                                                const correctAnswerText = question.correctAnswer === 'true' ? 'Đúng' : 'Sai';
                                                const studentAnswerText = studentAnswer === 'true' ? 'Đúng' : 'Sai';
                                                
                                                questionHtml = `
                                                    <div class="mb-4">
                                                        <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                                                        <div class="space-y-2 mb-3">
                                                            <div class="answer-label ${question.correctAnswer === 'true' ? 'correct-answer-label' : ''}">
                                                                <span>Đúng</span>
                                                                ${studentAnswer === 'true' ? 
                                                                    `<span class="student-answer ml-2">(Đáp án HS)</span>` : ''}
                                                                ${studentAnswer === 'true' && question.correctAnswer !== 'true' ? 
                                                                    `<i class="fas fa-times incorrect-icon ml-2"></i>` : ''}
                                                            </div>
                                                            <div class="answer-label ${question.correctAnswer === 'false' ? 'correct-answer-label' : ''}">
                                                                <span>Sai</span>
                                                                ${studentAnswer === 'false' ? 
                                                                    `<span class="student-answer ml-2">(Đáp án HS)</span>` : ''}
                                                                ${studentAnswer === 'false' && question.correctAnswer !== 'false' ? 
                                                                    `<i class="fas fa-times incorrect-icon ml-2"></i>` : ''}
                                                            </div>
                                                        </div>
                                                        <div class="text-sm text-gray-600">
                                                            <strong>Đáp án đúng:</strong> ${correctAnswerText}
                                                        </div>
                                                        <div class="mt-2 text-sm font-medium">
                                                            Điểm: ${isCorrect ? '1' : '0'}/1
                                                        </div>
                                                    </div>
                                                `;
                                            } else if (question.type === 'sa') {
                                                questionHtml = `
                                                    <div class="mb-4">
                                                        <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                                                        <div class="mb-3">
                                                            <p class="font-bold">Trả lời của thí sinh:</p>
                                                            <p class="bg-white p-2 border border-gray-300 rounded">${studentAnswer || 'Không trả lời'}</p>
                                                        </div>
                                                        <div class="text-sm text-gray-600">
                                                            <strong>Đáp án đúng:</strong> ${question.correctAnswer}
                                                        </div>
                                                        ${!isCorrect ? 
                                                            `<i class="fas fa-times incorrect-icon mt-2"></i>` : ''
                                                        }
                                                        <div class="mt-2 text-sm font-medium">
                                                            Điểm: ${isCorrect ? '1' : '0'}/1
                                                        </div>
                                                    </div>
                                                `;
                                            } else if (question.type === 'essay') {
                                                const manualScore = result.answers[index]?.manualScore || 0;
                                                questionHtml = `
                                                    <div class="mb-4">
                                                        <h3 class="text-lg font-medium mb-2">Câu ${index + 1}: ${question.question}</h3>
                                                        <div class="mb-3">
                                                            <p class="font-bold">Trả lời của thí sinh:</p>
                                                            <p class="bg-white p-2 border border-gray-300 rounded whitespace-pre-line">${studentAnswer || 'Không trả lời'}</p>
                                                        </div>
                                                        <div class="flex items-center mb-2">
                                                            <label class="mr-3">Điểm:</label>
                                                            <input type="number" min="0" max="1" step="0.5" value="${manualScore}" 
                                                                class="score-input border border-gray-300 rounded px-2 py-1 w-16" data-index="${index}">
                                                            <span class="ml-2">/ 1</span>
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                            
                                            questionElement.innerHTML = questionHtml;
                                            resultQuestionsContainer.appendChild(questionElement);
                                        }
                                    });
                                    
                                    // Enable save button for grading
                                    saveResultBtn.disabled = false;
                                    
                                    // Show modal
                                    resultModal.classList.remove('hidden');
                                });
                        });
                })
                .catch(error => {
                    console.error('Error loading exam result:', error);
                    alert('Có lỗi xảy ra khi tải bài thi');
                });
        }

        // Check if answer is correct (FIXED VERSION)
        function checkAnswerCorrect(question, answer) {
            if (question.type === 'mcq') {
                // Chuyển cả hai về string để so sánh
                return String(answer) === String(question.correctOption);
            } else if (question.type === 'tf') {
                return answer === question.correctAnswer;
            } else if (question.type === 'sa') {
                return answer.trim().toLowerCase() === question.correctAnswer.trim().toLowerCase();
            }
            return false; // Essays are manually graded
        }

        // Get violation type text
        function getViolationType(type) {
            const types = {
                'fullscreen_exit': 'Thoát chế độ toàn màn hình',
                'tab_switch': 'Chuyển tab trình duyệt',
                'camera_blocked': 'Không mở camera',
                'multiple_people': 'Phát hiện nhiều người trong camera',
                'no_person': 'Không phát hiện người trong camera',
                'audio_detected': 'Phát hiện tiếng nói',
                'electronic_device': 'Phát hiện thiết bị điện tử',
            };
            return types[type] || type;
        }

        // View violation
        function viewViolation(violationId) {
            db.collection('violations').doc(violationId).get()
                .then(doc => {
                    if (!doc.exists) {
                        alert('Vi phạm không tồn tại');
                        return;
                    }
                    
                    const violation = doc.data();
                    
                    // Get student name
                    db.collection('users').doc(violation.studentId).get()
                        .then(studentDoc => {
                            const studentName = studentDoc.exists ? studentDoc.data().name : 'Không xác định';
                            
                            // Get exam name
                            db.collection('exams').doc(violation.examId).get()
                                .then(examDoc => {
                                    const examName = examDoc.exists ? examDoc.data().name : 'Đề thi đã bị xóa';
                                    
                                    // Display violation details
                                    violationDetails.innerHTML = `
                                        <div class="space-y-4">
                                            <div>
                                                <h4 class="font-bold">Thí sinh:</h4>
                                                <p>${studentName}</p>
                                            </div>
                                            <div>
                                                <h4 class="font-bold">Đề thi:</h4>
                                                <p>${examName}</p>
                                            </div>
                                            <div>
                                                <h4 class="font-bold">Loại vi phạm:</h4>
                                                <p>${getViolationType(violation.type)}</p>
                                            </div>
                                            <div>
                                                <h4 class="font-bold">Thời gian:</h4>
                                                <p>${violation.timestamp.toDate().toLocaleString()}</p>
                                            </div>
                                            <div>
                                                <h4 class="font-bold">Chi tiết:</h4>
                                                <p>${violation.details || 'Không có chi tiết bổ sung'}</p>
                                            </div>
                                            ${violation.screenshot ? `
                                            <div>
                                                <h4 class="font-bold">Ảnh chụp:</h4>
                                                <img src="${violation.screenshot}" alt="Ảnh chụp vi phạm" class="mt-2 max-w-full h-auto border border-gray-200 rounded">
                                            </div>
                                            ` : ''}
                                        </div>
                                    `;
                                    
                                    violationModal.classList.remove('hidden');
                                });
                        });
                })
                .catch(error => {
                    console.error('Error viewing violation:', error);
                    alert('Có lỗi xảy ra khi xem vi phạm');
                });
        }

        // Save exam result
        function saveExamResult() {
            const maxScore = parseInt(document.getElementById('result-max-score').textContent);
            const totalScore = parseFloat(resultTotalScoreInput.value);
            
            // Validate total score
            if (isNaN(totalScore)) {
                alert('Vui lòng nhập điểm tổng hợp hợp lệ');
                return;
            }
            
            if (totalScore > maxScore) {
                alert(`Điểm tổng hợp không được vượt quá ${maxScore}`);
                return;
            }
            
            // Collect manual scores for essay questions
            const scoreInputs = document.querySelectorAll('.score-input');
            const manualScores = {};
            
            scoreInputs.forEach(input => {
                const index = parseInt(input.getAttribute('data-index'));
                const score = parseFloat(input.value) || 0;
                manualScores[index] = score;
            });
            
            // Update result in Firestore
            const updateData = {
                status: 'graded',
                finalScore: totalScore,
                gradedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Add manual scores to answers
            if (currentExamResult.answers) {
                currentExamResult.answers.forEach((answer, index) => {
                    if (currentExamData.content[index].type === 'essay') {
                        if (manualScores[index] !== undefined) {
                            answer.manualScore = manualScores[index];
                        }
                    }
                });
                
                updateData.answers = currentExamResult.answers;
            }
            
            db.collection('exam_results').doc(currentResultId).update(updateData)
                .then(() => {
                    alert('Đã lưu kết quả chấm bài thành công');
                    resultModal.classList.add('hidden');
                    loadResults();
                    loadStatistics();
                })
                .catch(error => {
                    console.error('Error saving exam result:', error);
                    alert('Có lỗi xảy ra khi lưu kết quả');
                });
        }

        // Delete exam
        function deleteExam(examId) {
            db.collection('exams').doc(examId).delete()
                .then(() => {
                    alert('Đã xóa đề thi thành công');
                    loadExams();
                    loadStatistics();
                })
                .catch(error => {
                    console.error('Error deleting exam:', error);
                    alert('Có lỗi xảy ra khi xóa đề thi');
                });
        }

        // Export exam results to Excel
        function exportExamResults(examId) {
            db.collection('exam_results')
                .where('examId', '==', examId)
                .where('teacherId', '==', currentUser.uid)
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        alert('Không có kết quả bài thi nào cho đề thi này');
                        return;
                    }
                    
                    const results = [];
                    const examPromises = [];
                    
                    querySnapshot.forEach(doc => {
                        const result = doc.data();
                        const promise = db.collection('users').doc(result.studentId).get()
                            .then(studentDoc => {
                                const studentName = studentDoc.exists ? studentDoc.data().name : 'Không xác định';
                                results.push({
                                    'STT': results.length + 1,
                                    'Tên thí sinh': studentName,
                                    'Điểm': result.finalScore || result.score || 0,
                                    'Ngày thi': result.submittedAt.toDate().toLocaleString(),
                                    'Trạng thái': getResultStatus(result, currentExamData)
                                });
                            });
                        examPromises.push(promise);
                    });
                    
                    Promise.all(examPromises).then(() => {
                        // Get exam name
                        db.collection('exams').doc(examId).get()
                            .then(examDoc => {
                                const examName = examDoc.exists ? examDoc.data().name : 'Đề thi không xác định';
                                
                                // Create workbook
                                const wb = XLSX.utils.book_new();
                                const ws = XLSX.utils.json_to_sheet(results);
                                
                                // Set column widths
                                ws['!cols'] = [
                                    { width: 4 }, // STT
                                    { width: 25 }, // Tên thí sinh
                                    { width: 7 },  // Điểm
                                    { width: 20 }, // Ngày thi
                                    { width: 20 }  // Trạng thái
                                ];
                                
                                XLSX.utils.book_append_sheet(wb, ws, "Kết quả");
                                
                                // Generate file name
                                const fileName = `Ket_qua_${examName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
                                
                                // Export to Excel
                                XLSX.writeFile(wb, fileName);
                                
                                // Close modal
                                exportExamModal.classList.add('hidden');
                            });
                    });
                })
                .catch(error => {
                    console.error('Error exporting results:', error);
                    alert('Có lỗi xảy ra khi xuất kết quả');
                });
        }

        // Show export exam modal
        exportExcelBtn.addEventListener('click', () => {
            exportExamSelect.innerHTML = '<option value="">-- Chọn đề thi --</option>';
            
            examListData.forEach(exam => {
                const option = document.createElement('option');
                option.value = exam.id;
                option.textContent = exam.name;
                exportExamSelect.appendChild(option);
            });
            
            exportExamModal.classList.remove('hidden');
        });

        // Close export modal
        closeExportModal.addEventListener('click', () => {
            exportExamModal.classList.add('hidden');
        });

        cancelExport.addEventListener('click', () => {
            exportExamModal.classList.add('hidden');
        });

        // Confirm export
        confirmExport.addEventListener('click', () => {
            const examId = exportExamSelect.value;
            if (!examId) {
                alert('Vui lòng chọn đề thi');
                return;
            }
            
            exportExamResults(examId);
        });

        // Add content item to exam form
        function addContentItem(type) {
            itemCount++;
            const itemId = `item-${itemCount}`;
            
            let itemHtml = '';
            
            if (type === 'mcq') {
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="mcq" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi trắc nghiệm #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required></textarea>
                        
                        <div class="options-container space-y-2 mb-3">
                            <div class="flex items-center">
                                <input type="radio" name="correct-option" value="0" class="mr-2" required>
                                <input type="text" class="option-input w-full px-3 py-1 border border-gray-300 rounded-md" placeholder="Lựa chọn 1" required>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" name="correct-option" value="1" class="mr-2">
                                <input type="text" class="option-input w-full px-3 py-1 border border-gray-300 rounded-md" placeholder="Lựa chọn 2" required>
                            </div>
                        </div>
                        
                        <button type="button" class="add-option text-blue-600 text-sm hover:text-blue-800">
                            <i class="fas fa-plus mr-1"></i>Thêm lựa chọn
                        </button>
                    </div>
                `;
            } else if (type === 'tf') {
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="tf" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi đúng/sai #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required></textarea>
                        
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="tf-answer" value="true" class="mr-2" required>
                                <span>Đúng</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="tf-answer" value="false" class="mr-2">
                                <span>Sai</span>
                            </label>
                        </div>
                    </div>
                `;
            } else if (type === 'sa') {
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="sa" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi trả lời ngắn #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required></textarea>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Câu trả lời đúng</label>
                            <input type="text" class="sa-answer w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>
                `;
            } else if (type === 'essay') {
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="essay" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi tự luận #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required></textarea>
                    </div>
                `;
            } else if (type === 'material') {
                itemHtml = `
                    <div class="content-block material-block p-4 rounded-lg border border-gray-200" data-type="material" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Tư liệu #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="material-content w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Nhập nội dung tư liệu" rows="4"></textarea>
                    </div>
                `;
            }
            
            const itemElement = document.createElement('div');
            itemElement.innerHTML = itemHtml;
            contentContainer.appendChild(itemElement);
            
            // Add event listeners
            const deleteBtn = itemElement.querySelector('.delete-item');
            deleteBtn.addEventListener('click', () => {
                itemElement.remove();
            });
            
            if (type === 'mcq') {
                const addOptionBtn = itemElement.querySelector('.add-option');
                const optionsContainer = itemElement.querySelector('.options-container');
                
                addOptionBtn.addEventListener('click', () => {
                    const optionCount = optionsContainer.children.length;
                    if (optionCount >= 5) {
                        alert('Tối đa 5 lựa chọn');
                        return;
                    }
                    
                    const optionElement = document.createElement('div');
                    optionElement.className = 'flex items-center';
                    optionElement.innerHTML = `
                        <input type="radio" name="correct-option" value="${optionCount}" class="mr-2">
                        <input type="text" class="option-input w-full px-3 py-1 border border-gray-300 rounded-md" placeholder="Lựa chọn ${optionCount + 1}" required>
                    `;
                    
                    optionsContainer.appendChild(optionElement);
                });
            }
        }

        // Process text content
        async function processTextContent() {
            const textContent = textContentInput.value.trim();
            if (!textContent) {
                showImportError('Vui lòng nhập nội dung đề thi');
                return;
            }
            
            // Show loading status
            importStatus.classList.remove('hidden');
            importError.classList.add('hidden');
            processTextBtn.disabled = true;
            
            try {
                // Call Gemini API
                const examData = await callGeminiAPI(textContent);
                
                // Fill the exam form with extracted data
                fillExamForm(examData);
                
                // Close modal
                importTextModal.classList.add('hidden');
                importStatus.classList.add('hidden');
                processTextBtn.disabled = false;
                
            } catch (error) {
                console.error('Error processing text content:', error);
                showImportError('Có lỗi xảy ra khi xử lý văn bản: ' + error.message);
                importStatus.classList.add('hidden');
                processTextBtn.disabled = false;
            }
        }

        // Call Gemini API
        async function callGeminiAPI(textContent) {
            const prompt = `
            Bạn là trợ lý chuyên phân tích và chuyển đổi đề thi từ văn bản thuần túy sang định dạng JSON. 
            Hãy phân tích nội dung và trích xuất thông tin đề thi theo cấu trúc sau:
            
            {
              "name": "Tên đề thi",
              "time": Thời gian làm bài (phút),
              "content": [
                {
                  "type": "material|mcq|tf|sa|essay",
                  "content": "Nội dung tư liệu" // Chỉ cho loại material
                  "question": "Nội dung câu hỏi", // Cho các loại câu hỏi
                  "options": ["Lựa chọn 1", "Lựa chọn 2", ...] // Chỉ cho loại mcq
                  "correctOption": "0", // Chỉ cho loại mcq (index của đáp án đúng)
                  "correctAnswer": "Đáp án đúng" // Cho loại tf, sa
                },
                ...
              ]
            }
            
            Quy tắc xác định loại nội dung:
            - material (tư liệu): Đoạn văn bản dài, không có câu hỏi kèm theo, dùng làm tài liệu tham khảo cho các câu hỏi sau
            - mcq (trắc nghiệm): Câu hỏi có nhiều lựa chọn (A, B, C, D...)
            - tf (đúng/sai): Câu hỏi chỉ có 2 lựa chọn Đúng/Sai
            - sa (trả lời ngắn): Câu hỏi yêu cầu trả lời ngắn (1-2 từ)
            - essay (tự luận): Câu hỏi yêu cầu trả lời dài, giải thích, phân tích
            
            Đặc biệt, nếu gặp đoạn văn có chỗ trống (ví dụ: (1)________) và sau đó là các câu hỏi điền vào chỗ trống,
            hãy chuyển đổi thành:
            1. Một tư liệu (material) chứa toàn bộ đoạn văn với các chỗ trống
            2. Các câu hỏi trả lời ngắn (sa) tương ứng với từng chỗ trống
            
            Ví dụ:
            Đoạn văn: "Are you ready to learn in a fun and easy way? Try SmartLearn – the app that makes studying (1)________ for everyone! SmartLearn helps students of all ages learn (2)________ and improve their grades."
            Câu hỏi 1: "Chỗ trống (1): A. exciting B. excited C. excitingly D. excitement"
            Câu hỏi 2: "Chỗ trống (2): A. new brand skills B. skills brand new C. new skills brand D. brand new skills"
            
            Sẽ được chuyển thành:
            {
              "type": "material",
              "content": "Are you ready to learn in a fun and easy way? Try SmartLearn – the app that makes studying (1)________ for everyone! SmartLearn helps students of all ages learn (2)________ and improve their grades."
            },
            {
              "type": "sa",
              "question": "Chỗ trống (1): A. exciting B. excited C. excitingly D. excitement",
              "correctAnswer": "A"
            },
            {
              "type": "sa",
              "question": "Chỗ trống (2): A. new brand skills B. skills brand new C. new skills brand D. brand new skills",
              "correctAnswer": "D"
            }
            
            Hãy phân tích kỹ nội dung và trả về kết quả dưới dạng JSON hợp lệ.
            
            Nội dung đề thi:
            ${textContent}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_CONFIG.model}:generateContent?key=${GEMINI_CONFIG.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { 
                                    text: prompt 
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 2048,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Lỗi khi gọi Gemini API');
                }

                const data = await response.json();
                const responseText = data.candidates[0].content.parts[0].text;
                
                // Extract JSON from response (might be wrapped in markdown code blocks)
                let jsonStr = responseText;
                const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || responseText.match(/```\n([\s\S]*?)\n```/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[1];
                }
                
                return JSON.parse(jsonStr);
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                throw new Error('Không thể xử lý văn bản: ' + error.message);
            }
        }

        // Fill exam form with extracted data
        function fillExamForm(examData) {
            // Fill basic info
            document.getElementById('exam-name').value = examData.name || 'Đề thi từ văn bản';
            document.getElementById('exam-time').value = examData.time || 45;
            
            // Clear existing content
            contentContainer.innerHTML = '';
            itemCount = 0;
            
            // Add content items
            if (examData.content && Array.isArray(examData.content)) {
                examData.content.forEach(item => {
                    addContentItemFromData(item);
                });
            }
        }

        // Add content item from extracted data
        function addContentItemFromData(itemData) {
            itemCount++;
            const itemId = `item-${itemCount}`;
            
            let itemHtml = '';
            
            if (itemData.type === 'mcq') {
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="mcq" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi trắc nghiệm #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required>${itemData.question || ''}</textarea>
                        
                        <div class="options-container space-y-2 mb-3">`;
                
                // Add options
                if (itemData.options && Array.isArray(itemData.options)) {
                    itemData.options.forEach((option, index) => {
                        const isChecked = itemData.correctOption === index.toString();
                        itemHtml += `
                            <div class="flex items-center">
                                <input type="radio" name="correct-option" value="${index}" class="mr-2" ${isChecked ? 'checked' : ''} required>
                                <input type="text" class="option-input w-full px-3 py-1 border border-gray-300 rounded-md" placeholder="Lựa chọn ${index + 1}" value="${option}" required>
                            </div>`;
                    });
                } else {
                    // Default options if none provided
                    itemHtml += `
                        <div class="flex items-center">
                            <input type="radio" name="correct-option" value="0" class="mr-2" required>
                            <input type="text" class="option-input w-full px-3 py-1 border border-gray-300 rounded-md" placeholder="Lựa chọn 1" required>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" name="correct-option" value="1" class="mr-2">
                            <input type="text" class="option-input w-full px-3 py-1 border border-gray-300 rounded-md" placeholder="Lựa chọn 2" required>
                        </div>`;
                }
                
                itemHtml += `
                        </div>
                        
                        <button type="button" class="add-option text-blue-600 text-sm hover:text-blue-800">
                            <i class="fas fa-plus mr-1"></i>Thêm lựa chọn
                        </button>
                    </div>`;
            } else if (itemData.type === 'tf') {
                const trueChecked = itemData.correctAnswer === 'true';
                const falseChecked = itemData.correctAnswer === 'false';
                
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="tf" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi đúng/sai #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required>${itemData.question || ''}</textarea>
                        
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="tf-answer" value="true" class="mr-2" ${trueChecked ? 'checked' : ''} required>
                                <span>Đúng</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="tf-answer" value="false" class="mr-2" ${falseChecked ? 'checked' : ''}>
                                <span>Sai</span>
                            </label>
                        </div>
                    </div>`;
            } else if (itemData.type === 'sa') {
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="sa" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi trả lời ngắn #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required>${itemData.question || ''}</textarea>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Câu trả lời đúng</label>
                            <input type="text" class="sa-answer w-full px-3 py-2 border border-gray-300 rounded-md" value="${itemData.correctAnswer || ''}" required>
                        </div>
                    </div>`;
            } else if (itemData.type === 'essay') {
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="essay" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi tự luận #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required>${itemData.question || ''}</textarea>
                    </div>`;
            } else if (itemData.type === 'material') {
                itemHtml = `
                    <div class="content-block material-block p-4 rounded-lg border border-gray-200" data-type="material" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Tư liệu #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="material-content w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Nhập nội dung tư liệu" rows="4">${itemData.content || ''}</textarea>
                    </div>
                `;
            } else {
                // Default to essay if type is unknown
                itemHtml = `
                    <div class="content-block bg-gray-50 p-4 rounded-lg border border-gray-200" data-type="essay" data-id="${itemId}">
                        <div class="flex justify-between items-start mb-2">
                            <label class="block text-sm font-medium text-gray-700">Câu hỏi #${itemCount}</label>
                            <button type="button" class="delete-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-md mb-3" placeholder="Nhập câu hỏi" required>${itemData.question || ''}</textarea>
                    </div>`;
            }
            
            const itemElement = document.createElement('div');
            itemElement.innerHTML = itemHtml;
            contentContainer.appendChild(itemElement);
            
            // Add event listeners
            const deleteBtn = itemElement.querySelector('.delete-item');
            deleteBtn.addEventListener('click', () => {
                itemElement.remove();
            });
            
            if (itemData.type === 'mcq') {
                const addOptionBtn = itemElement.querySelector('.add-option');
                const optionsContainer = itemElement.querySelector('.options-container');
                
                addOptionBtn.addEventListener('click', () => {
                    const optionCount = optionsContainer.children.length;
                    if (optionCount >= 5) {
                        alert('Tối đa 5 lựa chọn');
                        return;
                    }
                    
                    const optionElement = document.createElement('div');
                    optionElement.className = 'flex items-center';
                    optionElement.innerHTML = `
                        <input type="radio" name="correct-option" value="${optionCount}" class="mr-2">
                        <input type="text" class="option-input w-full px-3 py-1 border border-gray-300 rounded-md" placeholder="Lựa chọn ${optionCount + 1}" required>
                    `;
                    
                    optionsContainer.appendChild(optionElement);
                });
            }
        }

        // Show import error
        function showImportError(message) {
            importError.textContent = message;
            importError.classList.remove('hidden');
        }

        // Generate exam code
        function generateExamCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Toggle manual scoring mode
        manualScoringMode.addEventListener('change', () => {
            if (manualScoringMode.checked) {
                resultModal.classList.add('manual-input-mode');
                resultTotalScoreInput.disabled = false;
            } else {
                resultModal.classList.remove('manual-input-mode');
                resultTotalScoreInput.disabled = true;
            }
        });

        // Event listeners for modals
        closeResultModal.addEventListener('click', () => {
            resultModal.classList.add('hidden');
        });

        closeViolationModal.addEventListener('click', () => {
            violationModal.classList.add('hidden');
        });

        closeViolationModalBtn.addEventListener('click', () => {
            violationModal.classList.add('hidden');
        });

        saveResultBtn.addEventListener('click', saveExamResult);

        cancelResultBtn.addEventListener('click', () => {
            resultModal.classList.add('hidden');
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === resultModal) {
                resultModal.classList.add('hidden');
            }
            if (e.target === violationModal) {
                violationModal.classList.add('hidden');
            }
            if (e.target === createExamModal) {
                createExamModal.classList.add('hidden');
            }
            if (e.target === examCodeModal) {
                examCodeModal.classList.add('hidden');
            }
            if (e.target === exportExamModal) {
                exportExamModal.classList.add('hidden');
            }
            if (e.target === importTextModal) {
                importTextModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
