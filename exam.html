<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi Trực Tuyến - Anti Cheat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            font-family: 'Arial', sans-serif;
        }
        .hero-section {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23ffffff' fill-opacity='0.1' d='M0,128L48,117.3C96,107,192,85,288,112C384,139,480,213,576,218.7C672,224,768,160,864,138.7C960,117,1056,139,1152,149.3C1248,160,1344,160,1392,160L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover;
            background-position: bottom;
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 12px;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        .active-menu-item {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.2);
        }
        .mobile-menu {
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }
        .mobile-menu.open {
            max-height: 500px;
        }
        .feature-icon {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        .step-number {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-weight: bold;
            font-size: 1.25rem;
            color: white;
        }
        .nav-gradient {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #4f46e5;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #video-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid #e53e3e;
            border-radius: 8px;
            background-color: #000;
            z-index: 1000;
        }
        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .fullscreen-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 24px;
        }
        .camera-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            font-size: 24px;
        }
        .screenshare-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9997;
            font-size: 24px;
        }
        .hidden {
            display: none;
        }
        .question-block {
            transition: all 0.3s ease;
        }
        .question-block:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .timer {
            font-family: monospace;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .violation-warning {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #e53e3e;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
        }
        #audio-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            margin-top: 75px;
        }
        #photo-container {
            margin: 20px auto;
            width: 300px;
            height: 200px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #000;
            position: relative;
            overflow: hidden;
        }
        #photo-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #capture-btn {
            margin-top: 10px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #capture-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.3);
        }
        #canvas {
            display: none;
        }
        #api-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
            display: none;
        }
        .api-key-status {
            margin: 2px 0;
        }
        .api-active {
            color: #4CAF50;
        }
        .api-processing {
            color: #FFC107;
        }
        .api-error {
            color: #f44336;
        }
        #speech-recognition-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 1000;
        }
        .speech-active {
            color: #4CAF50;
        }
        .speech-error {
            color: #f44336;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        #screenshare-container {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 200px;
            height: 150px;
            border: 2px solid #38a169;
            border-radius: 8px;
            background-color: #000;
            z-index: 1000;
        }
        #screenshare-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav-gradient shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="home.html" class="flex items-center space-x-2">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt text-white text-xl"></i>
                        </div>
                        <span class="font-bold text-xl bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">ANTI CHEAT</span>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-1" id="desktop-menu">
                    <a href="home.html" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition">Trang chủ</a>
                    <a href="giamthi.html" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition">Giám thị AI</a>
                    <a href="exam.html" class="px-4 py-2 active-menu-item">Thi trực tuyến</a>
                    <a href="login.html" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition hidden" id="login-link">Đăng nhập</a>
                    <a href="register.html" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition hidden" id="register-link">Đăng ký</a>
                    <a href="management.html" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition hidden" id="exam-management-link">Quản lý đề thi</a>
                    <a href="#" class="px-4 py-2 text-gray-600 hover:text-indigo-600 transition" id="logout-link">Đăng xuất</a>
                </div>
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="p-2 focus:outline-none">
                        <i class="fas fa-bars text-gray-600 text-xl"></i>
                    </button>
                </div>
            </div>
            <!-- Mobile menu -->
            <div id="mobile-menu" class="mobile-menu md:hidden bg-white">
                <div class="px-2 pt-2 pb-3 space-y-1" id="mobile-menu-items">
                    <a href="home.html" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition">Trang chủ</a>
                    <a href="giamthi.html" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition">Giám thị AI</a>
                    <a href="exam.html" class="block px-3 py-2 active-menu-item">Thi trực tuyến</a>
                    <a href="login.html" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition hidden" id="mobile-login-link">Đăng nhập</a>
                    <a href="register.html" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition hidden" id="mobile-register-link">Đăng ký</a>
                    <a href="management.html" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition hidden" id="mobile-exam-management-link">Quản lý đề thi</a>
                    <a href="#" class="block px-3 py-2 text-gray-600 hover:text-indigo-600 transition" id="mobile-logout-link">Đăng xuất</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Camera Preview -->
    <div id="video-container" style="margin-top: 75px;">
        <video id="video-preview" autoplay muted playsinline></video>
    </div>
    
    <!-- Screen Share Preview -->
    <div id="screenshare-container" class="hidden">
        <video id="screenshare-preview" autoplay muted playsinline></video>
    </div>

    <!-- API Status -->
    <div id="api-status">
        <!-- API key status will be added dynamically -->
    </div>

    <!-- Speech Recognition Status -->
    <div id="speech-recognition-status" class="hidden">
        Trạng thái nhận dạng giọng nói: <span class="speech-state">Tắt</span>
    </div>

    <!-- Audio Indicator -->
    <div id="audio-indicator" class="hidden">
        <i class="fas fa-microphone-slash mr-2"></i>
        <span>Đang phân tích âm thanh</span>
    </div>

    <!-- Fullscreen Warning -->
    <div id="fullscreen-warning" class="fullscreen-warning hidden">
        <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
        <p class="text-center mb-6">Vui lòng vào chế độ toàn màn hình để tiếp tục làm bài</p>
        <button id="enter-fullscreen-btn" class="btn-primary px-6 py-3 rounded-lg">
            <i class="fas fa-expand mr-2"></i>Vào chế độ toàn màn hình
        </button>
    </div>

    <!-- Screen Share Warning -->
    <div id="screenshare-warning" class="screenshare-warning hidden">
        <i class="fas fa-desktop text-green-500 text-5xl mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">Yêu cầu chia sẻ màn hình</h2>
        <p class="text-center mb-6 max-w-lg">Để đảm bảo tính công bằng, bạn cần chia sẻ toàn bộ màn hình trong suốt quá trình làm bài. Hệ thống sẽ giám sát để phát hiện các hành vi truy cập tài liệu hoặc công cụ tìm kiếm trái phép.</p>
        <button id="start-screenshare-btn" class="btn-primary px-6 py-3 rounded-lg">
            <i class="fas fa-desktop mr-2"></i>Chia sẻ màn hình
        </button>
    </div>

    <!-- Camera Warning -->
    <div id="camera-warning" class="camera-warning">
        <i class="fas fa-video text-indigo-500 text-5xl mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">Yêu cầu truy cập camera & microphone</h2>
        <p class="text-center mb-6 max-w-lg">Để đảm bảo tính công bằng, bạn cần cho phép truy cập camera và microphone trong suốt quá trình làm bài. Hệ thống sẽ phát hiện các hành vi gian lận.</p>
        <button id="start-camera-btn" class="btn-primary px-6 py-3 rounded-lg">
            <i class="fas fa-camera mr-2"></i>Bắt đầu kiểm tra
        </button>
    </div>

    <!-- Photo Capture Section -->
    <div id="photo-section" class="hidden">
        <div class="max-w-4xl mx-auto px-4 py-8">
            <div class="bg-white shadow rounded-lg p-6 mb-8 text-center card">
                <h1 class="text-2xl font-bold mb-4 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Xác thực thí sinh</h1>
                <p class="mb-4 text-gray-600">Vui lòng chụp ảnh chân dung để xác minh danh tính trước khi bắt đầu làm bài</p>
                
                <div id="photo-container">
                    <video id="photo-preview" autoplay muted playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                
                <button id="capture-btn" class="btn-primary px-4 py-2 rounded-md">
                    <i class="fas fa-camera mr-2"></i>Chụp ảnh
                </button>
                
                <button id="confirm-photo-btn" class="btn-primary px-6 py-3 rounded-lg mt-4 hidden">
                    <i class="fas fa-check mr-2"></i>Xác nhận ảnh
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Exam Code Input -->
        <div id="exam-code-section" class="bg-white shadow rounded-lg p-6 mb-8 text-center card">
            <h1 class="text-2xl font-bold mb-4 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Nhập mã dự thi</h1>
            <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-4">
                <input type="text" id="exam-code-input" placeholder="Nhập mã dự thi" class="px-4 py-2 border border-gray-300 rounded-md w-full md:w-64">
                <span class="text-gray-500">hoặc</span>
                <button id="scan-qr-btn" class="btn-primary px-4 py-2 rounded-md">
                    <i class="fas fa-qrcode mr-2"></i>Quét mã QR
                </button>
            </div>
            <div id="qr-scan-container" class="mt-4 hidden">
                <div class="flex justify-center">
                    <video id="qr-video" width="300" height="200" class="border border-gray-300 rounded-md"></video>
                </div>
                <button id="stop-scan-btn" class="mt-2 btn-secondary px-4 py-2 rounded-md">
                    <i class="fas fa-stop mr-2"></i>Dừng quét
                </button>
            </div>
            <button id="start-exam-btn" class="mt-6 btn-primary px-6 py-3 rounded-lg hidden">
                <i class="fas fa-play mr-2"></i>Bắt đầu làm bài
            </button>
        </div>

        <!-- Exam Info -->
        <div id="exam-info-section" class="bg-white shadow rounded-lg p-6 mb-8 card hidden">
            <div class="flex justify-between items-center mb-4">
                <h1 id="exam-name" class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent"></h1>
                <div class="timer bg-gray-100 px-4 py-2 rounded-lg" id="exam-timer">00:00:00</div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <span class="text-gray-600">Thời gian làm bài:</span>
                    <span id="exam-duration" class="font-medium ml-2"></span>
                </div>
                <div>
                    <span class="text-gray-600">Số câu hỏi:</span>
                    <span id="exam-questions-count" class="font-medium ml-2"></span>
                </div>
            </div>
            <div class="border-t border-gray-200 pt-4">
                <p class="text-gray-600 mb-2">Lưu ý:</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    <li>Không được thoát khỏi chế độ toàn màn hình</li>
                    <li>Không được chuyển tab trình duyệt</li>
                    <li>Camera phải luôn bật và chỉ có 1 người trong khung hình</li>
                    <li>Không được trao đổi trong quá trình làm bài</li>
                    <li>Vi phạm sẽ được ghi lại và thông báo cho người quản lý</li>
                </ul>
            </div>
        </div>

        <!-- Exam Questions -->
        <div id="exam-questions-section" class="hidden">
            <form id="exam-form">
                <div id="questions-container" class="space-y-6">
                    <!-- Questions will be loaded here -->
                </div>
                
                <div class="mt-8 bg-white shadow rounded-lg p-6 card">
                    <button type="submit" id="submit-exam-btn" class="w-full btn-primary px-6 py-3 rounded-lg">
                        <i class="fas fa-paper-plane mr-2"></i>Nộp bài
                    </button>
                </div>
            </form>
        </div>

        <!-- Exam Completed -->
        <div id="exam-completed-section" class="bg-white shadow rounded-lg p-6 text-center card hidden">
            <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
            <h2 class="text-2xl font-bold mb-2 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Hoàn thành bài thi</h2>
            <p class="text-gray-600 mb-6">Bạn đã hoàn thành bài thi. Kết quả sẽ được thông báo sau khi giáo viên chấm điểm.</p>
            <button id="exit-exam-btn" class="btn-primary px-6 py-3 rounded-lg">
                <i class="fas fa-sign-out-alt mr-2"></i>Thoát
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p>Đang nộp bài...</p>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHAxN6WCc2_8aB9t3NuWroespDR7Ry4QQ",
            authDomain: "anticheat-749d6.firebaseapp.com",
            projectId: "anticheat-749d6",
            storageBucket: "anticheat-749d6.appspot.com",
            messagingSenderId: "417797975285",
            appId: "1:417797975285:web:71eadf4331ddb65968e9bc",
            measurementId: "G-4EDKFS0CY6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const examCodeInput = document.getElementById('exam-code-input');
        const scanQrBtn = document.getElementById('scan-qr-btn');
        const qrScanContainer = document.getElementById('qr-scan-container');
        const qrVideo = document.getElementById('qr-video');
        const stopScanBtn = document.getElementById('stop-scan-btn');
        const startExamBtn = document.getElementById('start-exam-btn');
        const examCodeSection = document.getElementById('exam-code-section');
        const examInfoSection = document.getElementById('exam-info-section');
        const examQuestionsSection = document.getElementById('exam-questions-section');
        const examCompletedSection = document.getElementById('exam-completed-section');
        const examForm = document.getElementById('exam-form');
        const questionsContainer = document.getElementById('questions-container');
        const submitExamBtn = document.getElementById('submit-exam-btn');
        const exitExamBtn = document.getElementById('exit-exam-btn');
        const examNameEl = document.getElementById('exam-name');
        const examDurationEl = document.getElementById('exam-duration');
        const examQuestionsCountEl = document.getElementById('exam-questions-count');
        const examTimerEl = document.getElementById('exam-timer');
        const fullscreenWarning = document.getElementById('fullscreen-warning');
        const enterFullscreenBtn = document.getElementById('enter-fullscreen-btn');
        const cameraWarning = document.getElementById('camera-warning');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const videoContainer = document.getElementById('video-container');
        const videoPreview = document.getElementById('video-preview');
        const audioIndicator = document.getElementById('audio-indicator');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const loginLink = document.getElementById('login-link');
        const registerLink = document.getElementById('register-link');
        const examManagementLink = document.getElementById('exam-management-link');
        const logoutLink = document.getElementById('logout-link');
        const mobileLoginLink = document.getElementById('mobile-login-link');
        const mobileRegisterLink = document.getElementById('mobile-register-link');
        const mobileExamManagementLink = document.getElementById('mobile-exam-management-link');
        const mobileLogoutLink = document.getElementById('mobile-logout-link');
        const photoSection = document.getElementById('photo-section');
        const photoPreview = document.getElementById('photo-preview');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const confirmPhotoBtn = document.getElementById('confirm-photo-btn');
        const photoContainer = document.getElementById('photo-container');
        const apiStatusContainer = document.getElementById('api-status');
        const speechRecognitionStatus = document.getElementById('speech-recognition-status');
        const speechStateElement = speechRecognitionStatus.querySelector('.speech-state');
        const loadingOverlay = document.getElementById('loading-overlay');
        const screenshareWarning = document.getElementById('screenshare-warning');
        const startScreenshareBtn = document.getElementById('start-screenshare-btn');
        const screenshareContainer = document.getElementById('screenshare-container');
        const screensharePreview = document.getElementById('screenshare-preview');

        // Variables
        let currentExam = null;
        let examTimer = null;
        let timeLeft = 0;
        let examStartTime = null;
        let cameraStream = null;
        let qrStream = null;
        let qrScannerActive = false;
        let violationCount = 0;
        let studentPhoto = null;
        let isExamSubmitted = false;
        let screenshareStream = null;
        let screenshareInterval = null;
        let violationWarningTimeout = null;
        let fullscreenCheckTimer = null;
        let isScreenshareActive = false;
        let screenshareCheckTime = 0;
        
        // Speech recognition variables
        let recognition = null;
        let isSpeechDetected = false;
        let speechTimeout = null;
        const SPEECH_TIMEOUT_DURATION = 3000;
        
        // Gemini API variables
        const API_KEYS = [
            'AIzaSyDN3FpLLxpue1y481xaIhrASCVpqbKxvdQ',
            'AIzaSyDSyoq4gsmAaKgaCD-93WuH7FjhdsRdD84',
            'AIzaSyAoA--31n5MR7pEQcsbK12BK_RHvZsZlkM',
            'AIzaSyAsFW9nUIfMka7U0ZjGPN8ETzh-q4tYxQ0'
        ];
        const SCAN_INTERVAL = 1500;
        let apiKeyTimers = [];
        let apiKeyElements = [];
        let apiKeyStats = [];
        let lastDetectionResult = null;
        
        // Temporary image storage with auto-cleanup
        let tempImages = {
            camera: Array(API_KEYS.length).fill(null),
            screen: Array(API_KEYS.length).fill(null)
        };
        
        // Image cleanup timers
        let imageCleanupTimers = [];
        
        // Violation tracking
        const VIOLATION_TYPES = {
            NO_PERSON: 'no_person',
            MULTIPLE_PEOPLE: 'multiple_people',
            ELECTRONIC_DEVICE: 'electronic_device',
            DOCUMENT_DETECTED: 'document_detected',
            AUDIO_DETECTED: 'audio_detected',
            FULLSCREEN_EXIT: 'fullscreen_exit',
            TAB_SWITCH: 'tab_switch',
            SCREEN_VIOLATION: 'screen_violation',
            SCREENSHARE_DISABLED: 'screenshare_disabled'
        };
        
        let activeViolations = {
            [VIOLATION_TYPES.NO_PERSON]: { active: false, timer: null, lastTime: 0 },
            [VIOLATION_TYPES.MULTIPLE_PEOPLE]: { active: false, timer: null, lastTime: 0 },
            [VIOLATION_TYPES.ELECTRONIC_DEVICE]: { active: false, timer: null, lastTime: 0 },
            [VIOLATION_TYPES.DOCUMENT_DETECTED]: { active: false, timer: null, lastTime: 0 },
            [VIOLATION_TYPES.AUDIO_DETECTED]: { active: false, timer: null, lastTime: 0 },
            [VIOLATION_TYPES.SCREEN_VIOLATION]: { active: false, timer: null, lastTime: 0 },
            [VIOLATION_TYPES.SCREENSHARE_DISABLED]: { active: false, timer: null, lastTime: 0 }
        };
        
        const VIOLATION_COOLDOWN = 4000;
        const SCREENSHARE_CHECK_DELAY = 3000; // 3 giây
        const IMAGE_CLEANUP_DELAY = 15000; // 15 giây

        // Initialize: Clean up old images on startup
        function initializeStorageCleanup() {
            // Clean up old temporary images on startup
            cleanupOldImages();
            
            // Set up periodic cleanup every 30 seconds
            setInterval(cleanupOldImages, 30000);
        }
        
        // Clean up old images from localStorage
        function cleanupOldImages() {
            const now = Date.now();
            const keysToRemove = [];
            
            // Iterate through all localStorage keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                
                // Check if key is a temporary or violation image
                if (key && (key.startsWith('temp_') || key.startsWith('violation_'))) {
                    try {
                        // Extract timestamp from key (format: type_apiIndex_timestamp)
                        const parts = key.split('_');
                        if (parts.length >= 3) {
                            const timestamp = parseInt(parts[parts.length - 1]);
                            
                            // Remove images older than 5 minutes (300000 ms)
                            if (!isNaN(timestamp) && now - timestamp > 300000) {
                                keysToRemove.push(key);
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing key:', key, e);
                    }
                }
            }
            
            // Remove old images
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log('Removed old image:', key);
            });
            
            if (keysToRemove.length > 0) {
                console.log(`Cleaned up ${keysToRemove.length} old images`);
            }
        }
        
        // Schedule image cleanup after a delay
        function scheduleImageCleanup(key, delay = IMAGE_CLEANUP_DELAY) {
            const timer = setTimeout(() => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    console.log('Auto-removed temporary image:', key);
                }
            }, delay);
            
            imageCleanupTimers.push(timer);
        }

        // Check auth state
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                updateMenuForLoggedInUser();
                // Initialize storage cleanup when user is authenticated
                initializeStorageCleanup();
            }
        });

        // Mobile menu toggle
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('open');
        });

        // Event listeners
        startExamBtn.addEventListener('click', startExam);
        scanQrBtn.addEventListener('click', startQRScan);
        stopScanBtn.addEventListener('click', stopQRScan);
        examForm.addEventListener('submit', handleSubmitExam);
        exitExamBtn.addEventListener('click', exitExam);
        enterFullscreenBtn.addEventListener('click', enterFullscreen);
        startCameraBtn.addEventListener('click', startCamera);
        logoutLink.addEventListener('click', signOut);
        mobileLogoutLink.addEventListener('click', signOut);
        captureBtn.addEventListener('click', capturePhoto);
        confirmPhotoBtn.addEventListener('click', confirmPhoto);
        startScreenshareBtn.addEventListener('click', startScreenShare);

        // Check for fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        // Check for visibility changes (tab switching)
        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Check exam code when input changes
        examCodeInput.addEventListener('input', checkExamCode);

        // Initialize API status UI
        function initApiStatusUI() {
            API_KEYS.forEach((key, index) => {
                const element = document.createElement('div');
                element.className = 'api-key-status';
                element.id = `api-key-${index}-status`;
                element.innerHTML = `API ${index+1}: <span class="api-state">Đang chờ</span>`;
                apiStatusContainer.appendChild(element);
                apiKeyElements.push(element);
                apiKeyStats.push({ usage: 0, errors: 0 });
            });
        }

        // Update API key status
        function updateApiKeyStatus(index, state) {
            const element = apiKeyElements[index];
            const stateElement = element.querySelector('.api-state');
            
            element.className = `api-key-status api-${state}`;
            stateElement.textContent = 
                state === 'active' ? 'Đang hoạt động' :
                state === 'processing' ? 'Đang xử lý' :
                state === 'error' ? 'Lỗi' : 'Đang chờ';
        }

        // Cập nhật menu khi đã đăng nhập
        function updateMenuForLoggedInUser() {
            loginLink.classList.add('hidden');
            registerLink.classList.add('hidden');
            logoutLink.classList.remove('hidden');
            examManagementLink.classList.remove('hidden');
            
            mobileLoginLink.classList.add('hidden');
            mobileRegisterLink.classList.add('hidden');
            mobileLogoutLink.classList.remove('hidden');
            mobileExamManagementLink.classList.remove('hidden');
        }

        // Hàm đăng xuất
        function signOut(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = 'home.html';
            }).catch((error) => {
                console.error('Lỗi khi đăng xuất:', error);
            });
        }

        // Start QR code scanning
        function startQRScan() {
            qrScanContainer.classList.remove('hidden');
            scanQrBtn.classList.add('hidden');
            qrScannerActive = true;
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
                .then(stream => {
                    qrStream = stream;
                    qrVideo.srcObject = stream;
                    qrVideo.play();
                    scanQRCode();
                })
                .catch(err => {
                    console.error("Error accessing camera for QR scan: ", err);
                    alert("Không thể truy cập camera để quét mã QR");
                    stopQRScan();
                });
        }

        // Stop QR code scanning
        function stopQRScan() {
            qrScannerActive = false;
            qrScanContainer.classList.add('hidden');
            scanQrBtn.classList.remove('hidden');
            
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
        }

        // Scan QR code from video stream
        function scanQRCode() {
            if (!qrScannerActive) return;
            
            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                canvas.width = qrVideo.videoWidth;
                canvas.height = qrVideo.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    examCodeInput.value = code.data;
                    stopQRScan();
                    checkExamCode();
                }
            }
            
            if (qrScannerActive) {
                requestAnimationFrame(scanQRCode);
            }
        }

        // Check exam code validity - FIXED VERSION
        function checkExamCode() {
            const code = examCodeInput.value.trim();
            
            if (code.length === 6) {
                db.collection('exams').where('code', '==', code).get()
                    .then(querySnapshot => {
                        if (!querySnapshot.empty) {
                            querySnapshot.forEach(doc => {
                                const examData = doc.data();
                                currentExam = {
                                    id: doc.id,
                                    name: examData.name,
                                    time: examData.time,
                                    code: examData.code,
                                    // FIX: Sử dụng items thay vì questions
                                    items: examData.items || [],
                                    createdBy: examData.createdBy
                                };
                                startExamBtn.classList.remove('hidden');
                            });
                        } else {
                            startExamBtn.classList.add('hidden');
                            alert('Mã dự thi không hợp lệ');
                        }
                    })
                    .catch(error => {
                        console.error('Error checking exam code: ', error);
                        alert('Có lỗi xảy ra khi kiểm tra mã dự thi');
                    });
            } else {
                startExamBtn.classList.add('hidden');
            }
        }

        // Start exam - FIXED VERSION
        function startExam() {
            if (!currentExam) return;
            
            examCodeSection.classList.add('hidden');
            examInfoSection.classList.remove('hidden');
            
            examNameEl.textContent = currentExam.name;
            examDurationEl.textContent = `${currentExam.time} phút`;
            
            // FIX: Đếm số câu hỏi (loại bỏ materials)
            const questionCount = currentExam.items ? 
                currentExam.items.filter(item => item.type !== 'material').length : 0;
            examQuestionsCountEl.textContent = questionCount;
            
            // Set timer
            timeLeft = currentExam.time * 60;
            examStartTime = new Date();
            updateTimer();
            examTimer = setInterval(updateTimer, 1000);
            
            // Load questions
            loadQuestions();
            
            // Show photo capture section
            photoSection.classList.remove('hidden');
            startPhotoCapture();
        }

        // Start photo capture
        function startPhotoCapture() {
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: 300, 
                    height: 200,
                    facingMode: 'user' 
                }, 
                audio: false 
            })
            .then(stream => {
                photoPreview.srcObject = stream;
            })
            .catch(err => {
                console.error("Error accessing camera for photo: ", err);
                alert("Không thể truy cập camera để chụp ảnh");
            });
        }

        // Capture photo
        function capturePhoto() {
            canvas.width = photoPreview.videoWidth;
            canvas.height = photoPreview.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(photoPreview, 0, 0, canvas.width, canvas.height);
            
            // Hide video and show captured photo
            photoPreview.classList.add('hidden');
            canvas.classList.remove('hidden');
            
            // Enable confirm button
            confirmPhotoBtn.classList.remove('hidden');
        }

        // Confirm photo and proceed
        function confirmPhoto() {
            // Get photo as data URL
            studentPhoto = canvas.toDataURL('image/jpeg');
            
            // Stop photo stream
            if (photoPreview.srcObject) {
                photoPreview.srcObject.getTracks().forEach(track => track.stop());
            }
            
            // Hide photo section and show screen share warning
            photoSection.classList.add('hidden');
            screenshareWarning.classList.remove('hidden');
        }

        // Start screen share
        async function startScreenShare() {
            try {
                screenshareStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always",
                        displaySurface: "monitor"
                    },
                    audio: false
                });
                
                // Theo dõi trạng thái chia sẻ màn hình
                isScreenshareActive = true;
                screenshareCheckTime = Date.now();
                
                screensharePreview.srcObject = screenshareStream;
                screenshareContainer.classList.remove('hidden');
                screenshareWarning.classList.add('hidden');
                
                // Xử lý khi người dùng dừng chia sẻ màn hình
                screenshareStream.getTracks().forEach(track => {
                    track.onended = () => {
                        isScreenshareActive = false;
                        screenshareContainer.classList.add('hidden');
                        handleScreenshareEnded();
                    };
                });
                
                // Tự động bật lại toàn màn hình sau khi chia sẻ màn hình
                setTimeout(() => {
                    enterFullscreen();
                    startScreenMonitoring();
                }, 1000);
                
            } catch (err) {
                console.error("Lỗi khi chia sẻ màn hình: ", err);
                alert("Bạn phải chia sẻ màn hình để tiếp tục làm bài thi");
            }
        }
        
        // Xử lý khi người dùng dừng chia sẻ màn hình
        function handleScreenshareEnded() {
            if (isExamSubmitted) return;
            
            // Chụp ảnh màn hình cuối cùng trước khi dừng
            captureScreenshotFromScreenShare().then(screenshot => {
                recordViolation(VIOLATION_TYPES.SCREENSHARE_DISABLED, 
                              "Thí sinh đã tắt chia sẻ màn hình", screenshot);
            });
            
            showViolationWarning("CẢNH BÁO: Bạn đã tắt chia sẻ màn hình. Hành động này đã được ghi lại.");
        }
        
        // Start screen monitoring
        function startScreenMonitoring() {
            screenshareInterval = setInterval(async () => {
                if (isExamSubmitted) return;
                
                const screenshot = await captureScreenshotFromScreenShare();
                
                // Lưu ảnh tạm vào local storage
                saveTempImage('screen', 0, screenshot);
                
                const result = await analyzeScreenContent(screenshot);
                if (result) {
                    handleScreenViolation(result, screenshot);
                }
            }, 8000);
        }
        
        // Capture screenshot from screen share
        async function captureScreenshotFromScreenShare() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = screensharePreview.videoWidth;
                canvas.height = screensharePreview.videoHeight;
                const ctx = canvas.getContext('2d');
                
                requestAnimationFrame(() => {
                    ctx.drawImage(screensharePreview, 0, 0, canvas.width, canvas.height);
                    const screenshot = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(screenshot);
                });
            });
        }
        
        // Analyze screen content
        async function analyzeScreenContent(screenshot) {
            const apiKey = API_KEYS[0];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;
            
            const prompt = `Phân tích hình ảnh màn hình máy tính và xác định xem người dùng có đang:
            1. Sử dụng trình duyệt web (Google, Bing, Cốc Cốc, v.v.) không phải là trang thi trực tuyến
            2. Sử dụng ứng dụng chat (Facebook Messenger, Zalo, WhatsApp, v.v.)
            3. Sử dụng công cụ AI (ChatGPT, Gemini, Bing AI, v.v.)
            4. Mở tài liệu, sách, PDF không được phép
            5. Bất kỳ hình thức tra cứu thông tin nào khác không liên quan đến bài thi
            
            Lưu ý: Đây là giao diện trang thi trực tuyến hợp lệ, không tính là vi phạm.
            
            Trả lời theo định dạng JSON chính xác:
            {
                "violation_detected": true/false,
                "violation_type": "Mô tả ngắn gọn vi phạm",
                "confidence": độ tin cậy từ 0-100
            }
            
            Chỉ trả lời bằng JSON.`;
            
            const requestData = {
                contents: [{
                    parts: [{
                        text: prompt
                    }, {
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: screenshot.split(',')[1]
                        }
                    }]
                }]
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const responseText = data.candidates[0].content.parts[0].text;
                    try {
                        const jsonStart = responseText.indexOf('{');
                        const jsonEnd = responseText.lastIndexOf('}') + 1;
                        const jsonStr = responseText.substring(jsonStart, jsonEnd);
                        const result = JSON.parse(jsonStr);
                        
                        return result;
                    } catch (e) {
                        console.error("Lỗi phân tích JSON màn hình:", e);
                        return null;
                    }
                }
                return null;
            } catch (error) {
                console.error("Lỗi phân tích màn hình:", error);
                return null;
            }
        }
        
        // Handle screen violation
        function handleScreenViolation(result, screenshot) {
            if (!result || !result.violation_detected || result.confidence < 70) {
                // Xóa ảnh tạm nếu không có vi phạm
                removeTempImage('screen', 0);
                return;
            }
            
            // Lưu ảnh vi phạm chính thức
            saveViolationImage('screen', 0, screenshot);
            
            recordViolation('screen_violation', `Phát hiện hành vi tra cứu tài liệu: ${result.violation_type} (Độ tin cậy: ${result.confidence}%)`, screenshot);
            
            showViolationWarning(`CẢNH BÁO: Phát hiện hành vi tra cứu tài liệu - ${result.violation_type}`);
        }

        // Initialize Web Speech API for voice detection
        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'vi-VN';
                
                recognition.onstart = () => {
                    speechRecognitionStatus.classList.remove('hidden');
                    speechStateElement.textContent = 'Đang hoạt động';
                    speechStateElement.className = 'speech-state speech-active';
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    speechStateElement.textContent = 'Lỗi: ' + event.error;
                    speechStateElement.className = 'speech-state speech-error';
                };
                
                recognition.onresult = (event) => {
                    if (isExamSubmitted) return;
                    
                    if (speechTimeout) {
                        clearTimeout(speechTimeout);
                    }
                    
                    if (!isSpeechDetected) {
                        isSpeechDetected = true;
                        handleViolation(VIOLATION_TYPES.AUDIO_DETECTED, 'Phát hiện tiếng nói trong quá trình thi');
                    }
                    
                    speechTimeout = setTimeout(() => {
                        isSpeechDetected = false;
                    }, SPEECH_TIMEOUT_DURATION);
                };
                
                recognition.start();
                
                recognition.onend = () => {
                    if (!isExamSubmitted) {
                        recognition.start();
                    }
                };
                
            } catch (error) {
                console.error('Speech recognition not supported or error initializing:', error);
                speechRecognitionStatus.classList.remove('hidden');
                speechStateElement.textContent = 'Không hỗ trợ';
                speechStateElement.className = 'speech-state speech-error';
            }
        }

        // Initialize face-api.js and start camera & microphone
        async function startCamera() {
            cameraWarning.classList.add('hidden');
            audioIndicator.classList.remove('hidden');
            apiStatusContainer.style.display = 'block';
            initApiStatusUI();
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: 640, 
                        height: 480,
                        facingMode: 'user' 
                    }, 
                    audio: true 
                });
                
                cameraStream = stream;
                videoPreview.srcObject = stream;
                videoPreview.width = 640;
                videoPreview.height = 480;
                
                initSpeechRecognition();
                
                startAutoScan();
                
                enterFullscreen();
                
            } catch (err) {
                console.error("Error accessing camera/microphone: ", err);
                alert("Bạn phải cho phép truy cập camera và microphone để tiếp tục làm bài");
                cameraWarning.classList.remove('hidden');
                audioIndicator.classList.add('hidden');
                apiStatusContainer.style.display = 'none';
            }
        }

        // Capture image from video stream
        function captureImage() {
            const canvas = document.createElement('canvas');
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
            
            return canvas.toDataURL('image/jpeg', 0.9);
        }

        // Save temporary image to local storage with auto-cleanup
        function saveTempImage(type, apiKeyIndex, imageData) {
            try {
                const key = `temp_${type}_${apiKeyIndex}_${Date.now()}`;
                localStorage.setItem(key, imageData);
                tempImages[type][apiKeyIndex] = key;
                
                // Schedule cleanup after 15 seconds
                scheduleImageCleanup(key);
                
                return key;
            } catch (error) {
                console.error('Error saving temporary image:', error);
                
                // If storage is full, try to clean up and retry
                if (error.name === 'QuotaExceededError') {
                    console.log('Storage full, cleaning up old images...');
                    cleanupOldImages();
                    
                    // Try again after cleanup
                    try {
                        const key = `temp_${type}_${apiKeyIndex}_${Date.now()}`;
                        localStorage.setItem(key, imageData);
                        tempImages[type][apiKeyIndex] = key;
                        
                        // Schedule cleanup after 15 seconds
                        scheduleImageCleanup(key);
                        
                        return key;
                    } catch (retryError) {
                        console.error('Still unable to save image after cleanup:', retryError);
                        return null;
                    }
                }
                return null;
            }
        }
        
        // Remove temporary image from local storage
        function removeTempImage(type, apiKeyIndex) {
            const key = tempImages[type][apiKeyIndex];
            if (key) {
                try {
                    localStorage.removeItem(key);
                    tempImages[type][apiKeyIndex] = null;
                } catch (error) {
                    console.error('Error removing temporary image:', error);
                }
            }
        }
        
        // Save violation image to local storage
        function saveViolationImage(type, apiKeyIndex, imageData) {
            try {
                const key = `violation_${type}_${apiKeyIndex}_${Date.now()}`;
                localStorage.setItem(key, imageData);
                
                // Schedule cleanup after 5 minutes for violation images
                scheduleImageCleanup(key, 300000);
                
                return key;
            } catch (error) {
                console.error('Error saving violation image:', error);
                
                // If storage is full, try to clean up and retry
                if (error.name === 'QuotaExceededError') {
                    console.log('Storage full, cleaning up old images...');
                    cleanupOldImages();
                    
                    // Try again after cleanup
                    try {
                        const key = `violation_${type}_${apiKeyIndex}_${Date.now()}`;
                        localStorage.setItem(key, imageData);
                        
                        // Schedule cleanup after 5 minutes for violation images
                        scheduleImageCleanup(key, 300000);
                        
                        return key;
                    } catch (retryError) {
                        console.error('Still unable to save violation image after cleanup:', retryError);
                        return null;
                    }
                }
                return null;
            }
        }

        // Analyze image using Gemini API
        async function analyzeImage(apiKeyIndex) {
            if (isExamSubmitted) return null;
            
            const apiKey = API_KEYS[apiKeyIndex];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`;
            
            const prompt = `Phân tích hình ảnh và trả lời theo định dạng JSON chính xác:
                {
                    "people": số lượng người trong hình,
                    "electronic_devices": [danh sách thiết bị điện tử (điện thoại, laptop, máy tính bảng)],
                    "documents": [danh sách tài liệu, giấy tờ, sách vở],
                    "confidence": mức độ chắc chắn từ 0-100
                }
                Lưu ý: Máy tính cầm tay (casio) không tính là thiết bị điện tử. Chỉ trả lời bằng JSON.`;
            
            const imageData = captureImage();
            
            // Lưu ảnh tạm vào local storage
            const tempKey = saveTempImage('camera', apiKeyIndex, imageData);
            
            if (!tempKey) {
                console.error('Failed to save temporary image, skipping analysis');
                return null;
            }
            
            const requestData = {
                contents: [{
                    parts: [{
                        text: prompt
                    }, {
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: imageData.split(',')[1]
                        }
                    }]
                }]
            };
            
            try {
                updateApiKeyStatus(apiKeyIndex, 'processing');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                apiKeyStats[apiKeyIndex].usage++;
                
                if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const responseText = data.candidates[0].content.parts[0].text;
                    try {
                        const jsonStart = responseText.indexOf('{');
                        const jsonEnd = responseText.lastIndexOf('}') + 1;
                        const jsonStr = responseText.substring(jsonStart, jsonEnd);
                        const result = JSON.parse(jsonStr);
                        
                        updateApiKeyStatus(apiKeyIndex, 'active');
                        return result;
                    } catch (e) {
                        console.error("Lỗi phân tích JSON:", e);
                        throw new Error("Invalid JSON response");
                    }
                }
                throw new Error("Invalid API response");
            } catch (error) {
                console.error(`Lỗi API key ${apiKeyIndex+1}:`, error);
                apiKeyStats[apiKeyIndex].errors++;
                updateApiKeyStatus(apiKeyIndex, 'error');
                return null;
            }
        }

        // Handle detection results from Gemini API
        function handleDetection(result, apiKeyIndex) {
            if (isExamSubmitted) return;
            
            if (!result) {
                // Xóa ảnh tạm nếu không có kết quả
                removeTempImage('camera', apiKeyIndex);
                return;
            }
            
            lastDetectionResult = result;
            
            // Check number of people
            if (result.people === 0) {
                // Lưu ảnh vi phạm chính thức
                const violationImage = localStorage.getItem(tempImages.camera[apiKeyIndex]);
                if (violationImage) {
                    saveViolationImage('camera', apiKeyIndex, violationImage);
                }
                
                handleViolation(VIOLATION_TYPES.NO_PERSON, "Không phát hiện khuôn mặt trong camera");
            } else if (result.people > 1) {
                // Lưu ảnh vi phạm chính thức
                const violationImage = localStorage.getItem(tempImages.camera[apiKeyIndex]);
                if (violationImage) {
                    saveViolationImage('camera', apiKeyIndex, violationImage);
                }
                
                handleViolation(VIOLATION_TYPES.MULTIPLE_PEOPLE, `Phát hiện ${result.people} khuôn mặt trong camera (chỉ cho phép 1 người)`);
            } else {
                // Xóa ảnh tạm nếu không có vi phạm
                removeTempImage('camera', apiKeyIndex);
                resetViolationTimer(VIOLATION_TYPES.NO_PERSON);
                resetViolationTimer(VIOLATION_TYPES.MULTIPLE_PEOPLE);
            }
            
            // Check for electronic devices
            if (result.electronic_devices && result.electronic_devices.length > 0) {
                // Lưu ảnh vi phạm chính thức
                const violationImage = localStorage.getItem(tempImages.camera[apiKeyIndex]);
                if (violationImage) {
                    saveViolationImage('camera', apiKeyIndex, violationImage);
                }
                
                handleViolation(VIOLATION_TYPES.ELECTRONIC_DEVICE, `Phát hiện thiết bị điện tử: ${result.electronic_devices.join(', ')}`);
            } else {
                resetViolationTimer(VIOLATION_TYPES.ELECTRONIC_DEVICE);
            }
            
            // Check for documents
            if (result.documents && result.documents.length > 0) {
                // Lưu ảnh vi phạm chính thức
                const violationImage = localStorage.getItem(tempImages.camera[apiKeyIndex]);
                if (violationImage) {
                    saveViolationImage('camera', apiKeyIndex, violationImage);
                }
                
                handleViolation(VIOLATION_TYPES.DOCUMENT_DETECTED, `Phát hiện tài liệu, giấy tờ: ${result.documents.join(', ')}`);
            } else {
                resetViolationTimer(VIOLATION_TYPES.DOCUMENT_DETECTED);
            }
        }

        // Handle violation with cooldown
        function handleViolation(type, message) {
            if (isExamSubmitted) return;
            
            const now = Date.now();
            const violation = activeViolations[type];
            
            if (!violation.active || now - violation.lastTime > VIOLATION_COOLDOWN) {
                violation.active = true;
                violation.lastTime = now;
                
                recordViolation(type, message);
                
                if (violation.timer) {
                    clearTimeout(violation.timer);
                }
                violation.timer = setTimeout(() => {
                    violation.active = false;
                }, VIOLATION_COOLDOWN);
            }
        }

        // Reset violation timer
        function resetViolationTimer(type) {
            const violation = activeViolations[type];
            if (violation.timer) {
                clearTimeout(violation.timer);
                violation.active = false;
            }
        }

        // Setup scanner for each API key
        function setupApiScanner(apiKeyIndex) {
            return setInterval(async () => {
                if (isExamSubmitted) return;
                
                const result = await analyzeImage(apiKeyIndex);
                if (result) {
                    handleDetection(result, apiKeyIndex);
                }
            }, API_KEYS.length * SCAN_INTERVAL);
        }

        // Start auto scanning with all API keys
        function startAutoScan() {
            API_KEYS.forEach((_, index) => {
                setTimeout(() => {
                    apiKeyTimers[index] = setupApiScanner(index);
                }, index * SCAN_INTERVAL);
            });
        }

        // Stop all scanning
        function stopAllScans() {
            apiKeyTimers.forEach(timer => clearInterval(timer));
            imageCleanupTimers.forEach(timer => clearTimeout(timer));
        }

        // Fast screenshot capture
        async function captureScreenshot() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = videoPreview.videoWidth;
                canvas.height = videoPreview.videoHeight;
                const ctx = canvas.getContext('2d');
                
                requestAnimationFrame(() => {
                    ctx.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
                    const screenshot = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(screenshot);
                });
            });
        }

        // Record violation to Firestore (optimized)
        async function recordViolation(type, details, screenshot = null) {
            if (isExamSubmitted) return;
            
            violationCount++;
            
            // Nếu không có ảnh được cung cấp, chụp ảnh mới
            if (!screenshot) {
                if (type === VIOLATION_TYPES.SCREEN_VIOLATION || 
                    type === VIOLATION_TYPES.TAB_SWITCH || 
                    type === VIOLATION_TYPES.FULLSCREEN_EXIT ||
                    type === VIOLATION_TYPES.SCREENSHARE_DISABLED) {
                    // Đối với vi phạm màn hình, sử dụng ảnh từ chia sẻ màn hình
                    if (isScreenshareActive) {
                        screenshot = await captureScreenshotFromScreenShare();
                    }
                } else {
                    // Đối với vi phạm camera, sử dụng ảnh từ camera
                    screenshot = await captureScreenshot();
                }
            }
            
            const violationData = {
                examId: currentExam.id,
                studentId: auth.currentUser.uid,
                teacherId: currentExam.createdBy,
                type: type,
                details: details,
                screenshot: screenshot,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                faceCount: lastDetectionResult?.people || 0,
                devicesDetected: lastDetectionResult?.electronic_devices?.join(', ') || 'none',
                documentsDetected: lastDetectionResult?.documents?.join(', ') || 'none'
            };
            
            db.collection('violations').add(violationData)
                .then(() => console.log('Violation recorded:', type))
                .catch(error => console.error('Error recording violation: ', error));
            
            showViolationWarning(details);
        }

        // Show violation warning to user
        function showViolationWarning(message) {
            if (isExamSubmitted) return;
            
            const existingWarning = document.querySelector('.violation-warning');
            if (existingWarning) {
                existingWarning.remove();
                clearTimeout(violationWarningTimeout);
            }
            
            const warningDiv = document.createElement('div');
            warningDiv.className = 'violation-warning';
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(warningDiv);
            
            violationWarningTimeout = setTimeout(() => {
                warningDiv.remove();
            }, 5000);
        }

        // Enter fullscreen mode
        function enterFullscreen() {
            if (!document.fullscreenElement) {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            }
        }

        // Handle fullscreen change
        function handleFullscreenChange() {
            if (isExamSubmitted) return;
            
            const isFullscreen = document.fullscreenElement || 
                               document.webkitFullscreenElement || 
                               document.msFullscreenElement;
            
            // Chỉ kiểm tra vi phạm fullscreen nếu đã qua 3 giây kể từ khi chia sẻ màn hình
            const currentTime = Date.now();
            if (isScreenshareActive && currentTime - screenshareCheckTime > SCREENSHARE_CHECK_DELAY) {
                if (!isFullscreen && examQuestionsSection.classList.contains('hidden') === false) {
                    fullscreenWarning.classList.remove('hidden');
                    
                    // Chụp ảnh màn hình khi vi phạm
                    captureScreenshotFromScreenShare().then(screenshot => {
                        recordViolation(VIOLATION_TYPES.FULLSCREEN_EXIT, 
                                      'Thí sinh thoát chế độ toàn màn hình', screenshot);
                    });
                } else {
                    fullscreenWarning.classList.add('hidden');
                }
            }
        }

        // Handle visibility change (tab switching)
        function handleVisibilityChange() {
            if (isExamSubmitted) return;
            
            if (document.hidden && examQuestionsSection.classList.contains('hidden') === false) {
                // Chụp ảnh màn hình khi vi phạm
                captureScreenshotFromScreenShare().then(screenshot => {
                    recordViolation(VIOLATION_TYPES.TAB_SWITCH, 
                                  'Thí sinh chuyển tab trình duyệt', screenshot);
                });
                
                showViolationWarning('CẢNH BÁO: Bạn đã chuyển tab trình duyệt. Hành động này đã được ghi lại.');
            }
        }

        // Load questions from exam data - FIXED VERSION
        function loadQuestions() {
            questionsContainer.innerHTML = '';
            
            if (!currentExam.items || currentExam.items.length === 0) {
                questionsContainer.innerHTML = '<div class="text-center p-8 text-gray-500">Không có câu hỏi nào trong đề thi</div>';
                return;
            }
            
            let questionIndex = 0;
            
            currentExam.items.forEach((item, index) => {
                // Bỏ qua các mục là tư liệu (materials)
                if (item.type === 'material') {
                    return;
                }
                
                questionIndex++;
                const questionEl = document.createElement('div');
                questionEl.className = 'question-block bg-white shadow rounded-lg p-6 card';
                
                if (item.type === 'mcq') {
                    questionEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-lg font-medium mb-2">Câu ${questionIndex}: ${item.question}</h3>
                            <div class="space-y-2">
                                ${item.options.map((option, i) => `
                                    <label class="flex items-center">
                                        <input type="radio" name="q${index}" value="${i}" class="mr-2">
                                        ${String.fromCharCode(65 + i)}. ${option}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (item.type === 'tf') {
                    questionEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-lg font-medium mb-2">Câu ${questionIndex}: ${item.question}</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="q${index}" value="true" class="mr-2">
                                    Đúng
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="q${index}" value="false" class="mr-2">
                                    Sai
                                </label>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'sa') {
                    questionEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-lg font-medium mb-2">Câu ${questionIndex}: ${item.question}</h3>
                            <input type="text" name="q${index}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    `;
                } else if (item.type === 'essay') {
                    questionEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-lg font-medium mb-2">Câu ${questionIndex}: ${item.question}</h3>
                            <textarea name="q${index}" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="4"></textarea>
                        </div>
                    `;
                }
                
                questionsContainer.appendChild(questionEl);
            });
            
            // Hiển thị tư liệu nếu có
            const materials = currentExam.items.filter(item => item.type === 'material');
            if (materials.length > 0) {
                const materialsContainer = document.createElement('div');
                materialsContainer.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6';
                materialsContainer.innerHTML = `
                    <h3 class="text-lg font-medium text-blue-800 mb-2">Tư liệu tham khảo</h3>
                    ${materials.map((material, i) => `
                        <div class="mb-3 p-3 bg-white rounded border">
                            <p class="text-gray-700 whitespace-pre-line">${material.content}</p>
                        </div>
                    `).join('')}
                `;
                questionsContainer.insertBefore(materialsContainer, questionsContainer.firstChild);
            }
            
            examInfoSection.classList.add('hidden');
            examQuestionsSection.classList.remove('hidden');
        }

        // Update exam timer
        function updateTimer() {
            if (timeLeft <= 0) {
                clearInterval(examTimer);
                handleSubmitExam();
                return;
            }
            
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            
            examTimerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timeLeft--;
        }

        // Handle exam submission with loading effect
        function handleSubmitExam(e) {
            if (e) e.preventDefault();
            
            isExamSubmitted = true;
            
            loadingOverlay.classList.remove('hidden');
            
            stopAntiCheatMonitoring();
            
            setTimeout(() => {
                stopCameraAndMic();
                submitExam();
            }, 1000);
        }

        // Stop anti-cheat monitoring immediately
        function stopAntiCheatMonitoring() {
            stopAllScans();
            
            if (recognition) {
                recognition.stop();
            }
            
            if (screenshareInterval) {
                clearInterval(screenshareInterval);
            }
            
            if (screenshareStream) {
                screenshareStream.getTracks().forEach(track => track.stop());
            }
            
            audioIndicator.classList.add('hidden');
            apiStatusContainer.style.display = 'none';
            speechRecognitionStatus.classList.add('hidden');
            screenshareContainer.classList.add('hidden');
            
            // Xóa tất cả ảnh tạm
            clearAllTempImages();
        }
        
        // Clear all temporary images
        function clearAllTempImages() {
            // Xóa ảnh tạm camera
            for (let i = 0; i < API_KEYS.length; i++) {
                if (tempImages.camera[i]) {
                    localStorage.removeItem(tempImages.camera[i]);
                    tempImages.camera[i] = null;
                }
            }
            
            // Xóa ảnh tạm màn hình
            for (let i = 0; i < API_KEYS.length; i++) {
                if (tempImages.screen[i]) {
                    localStorage.removeItem(tempImages.screen[i]);
                    tempImages.screen[i] = null;
                }
            }
        }

        // Stop camera and microphone
        function stopCameraAndMic() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            videoContainer.classList.add('hidden');
        }

        // Submit exam - FIXED VERSION
        async function submitExam() {
            clearInterval(examTimer);
            
            const answers = [];
            const formData = new FormData(examForm);
            
            currentExam.items.forEach((item, index) => {
                // Skip materials
                if (item.type === 'material') return;
                
                const answer = formData.get(`q${index}`);
                answers.push({
                    answer: answer || '',
                    manualScore: item.type === 'essay' ? null : 0
                });
            });
            
            const timeTaken = currentExam.time * 60 - timeLeft;
            
            try {
                await db.collection('exam_results').add({
                    examId: currentExam.id,
                    studentId: auth.currentUser.uid,
                    teacherId: currentExam.createdBy,
                    answers: answers,
                    timeTaken: timeTaken,
                    violations: violationCount,
                    studentPhoto: studentPhoto,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });
                
                loadingOverlay.classList.add('hidden');
                
                examQuestionsSection.classList.add('hidden');
                examCompletedSection.classList.remove('hidden');
                
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            } catch (error) {
                console.error('Error submitting exam: ', error);
                loadingOverlay.classList.add('hidden');
                alert('Có lỗi xảy ra khi nộp bài. Vui lòng thử lại.');
            }
        }

        // Exit exam
        function exitExam() {
            stopAntiCheatMonitoring();
            stopCameraAndMic();
            window.location.href = 'home.html';
        }
    </script>
</body>
</html>
