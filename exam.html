<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANTI CHEAT - Thi trực tuyến</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
        }
        #fullscreen-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #camera-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9998;
        }
        #exam-container {
            transition: opacity 0.3s ease;
        }
        .blurred {
            filter: blur(5px);
            pointer-events: none;
        }
        #camera-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            border: 3px solid #4f46e5;
            border-radius: 8px;
            z-index: 100;
        }
        #face-detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .permission-request {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Fullscreen warning -->
    <div id="fullscreen-warning" class="hidden">
        <div class="text-center p-6 max-w-md">
            <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i>
            <h2 class="text-2xl font-bold mb-4">Cảnh báo!</h2>
            <p class="mb-6">Bạn đã thoát khỏi chế độ toàn màn hình. Vui lòng quay lại chế độ toàn màn hình để tiếp tục làm bài.</p>
            <button id="return-fullscreen" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                Quay lại toàn màn hình
            </button>
        </div>
    </div>

    <!-- Camera warning -->
    <div id="camera-warning" class="hidden">
        <div class="text-center p-6 max-w-md">
            <i class="fas fa-video-slash text-5xl text-red-400 mb-4"></i>
            <h2 class="text-2xl font-bold mb-4">Yêu cầu camera</h2>
            <p class="mb-6">Bạn cần bật camera để có thể tham gia thi. Vui lòng cho phép truy cập camera và đảm bảo camera không bị che.</p>
            <button id="check-camera" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                Kiểm tra lại camera
            </button>
        </div>
    </div>

    <!-- Camera preview -->
    <div id="camera-container" class="hidden">
        <video id="camera-preview" autoplay muted></video>
        <canvas id="face-detection-overlay"></canvas>
    </div>

    <!-- Exam container -->
    <div id="exam-container" class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Exam header -->
            <div class="bg-indigo-600 text-white p-4">
                <div class="flex justify-between items-center">
                    <h1 id="exam-name" class="text-xl font-bold">Đang tải đề thi...</h1>
                    <div class="flex items-center space-x-4">
                        <div id="timer" class="bg-indigo-800 px-3 py-1 rounded-lg font-mono">00:00</div>
                        <button id="submit-exam" class="bg-white text-indigo-600 px-3 py-1 rounded-lg font-medium hover:bg-gray-100 hidden">
                            Nộp bài
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Exam content -->
            <div class="p-6">
                <div id="exam-code-section" class="mb-8">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h2 class="text-lg font-bold mb-2">Nhập mã dự thi</h2>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="exam-code-input" placeholder="Nhập mã dự thi" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="start-exam" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">
                                Bắt đầu thi
                            </button>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            Hoặc sử dụng camera để quét mã QR từ giám thị
                        </div>
                    </div>
                    
                    <!-- Camera permission request -->
                    <div id="camera-permission-request" class="mt-6 bg-blue-50 p-4 rounded-lg border border-blue-200 permission-request">
                        <div class="flex items-center">
                            <i class="fas fa-video text-blue-500 text-xl mr-3"></i>
                            <div>
                                <h3 class="font-bold text-blue-800">Yêu cầu cấp quyền camera</h3>
                                <p class="text-sm text-blue-700">Hệ thống sẽ tự động yêu cầu quyền truy cập camera khi bạn bắt đầu làm bài</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="exam-content" class="hidden">
                    <div id="exam-instructions" class="mb-8 bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h2 class="text-lg font-bold mb-2 text-blue-800">Hướng dẫn làm bài</h2>
                        <ul class="list-disc pl-5 space-y-1 text-blue-700">
                            <li>Bài thi sẽ tự động nộp khi hết thời gian</li>
                            <li>Không được phép thoát khỏi chế độ toàn màn hình</li>
                            <li>Không được phép chuyển tab trình duyệt</li>
                            <li>Camera phải luôn bật và không bị che trong suốt quá trình thi</li>
                        </ul>
                    </div>
                    
                    <div id="questions-container" class="space-y-8">
                        <!-- Questions will be loaded here -->
                    </div>
                    
                    <div class="mt-8 flex justify-end">
                        <button id="submit-exam-bottom" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 hidden">
                            Nộp bài
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHAxN6WCc2_8aB9t3NuWroespDR7Ry4QQ",
            authDomain: "anticheat-749d6.firebaseapp.com",
            projectId: "anticheat-749d6",
            storageBucket: "anticheat-749d6.firebasestorage.app",
            messagingSenderId: "417797975285",
            appId: "1:417797975285:web:71eadf4331ddb65968e9bc",
            measurementId: "G-4EDKFS0CY6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const examContainer = document.getElementById('exam-container');
        const examCodeSection = document.getElementById('exam-code-section');
        const examContent = document.getElementById('exam-content');
        const examName = document.getElementById('exam-name');
        const timer = document.getElementById('timer');
        const examCodeInput = document.getElementById('exam-code-input');
        const startExamBtn = document.getElementById('start-exam');
        const submitExamBtn = document.getElementById('submit-exam');
        const submitExamBottomBtn = document.getElementById('submit-exam-bottom');
        const questionsContainer = document.getElementById('questions-container');
        const fullscreenWarning = document.getElementById('fullscreen-warning');
        const returnFullscreenBtn = document.getElementById('return-fullscreen');
        const cameraWarning = document.getElementById('camera-warning');
        const checkCameraBtn = document.getElementById('check-camera');
        const cameraContainer = document.getElementById('camera-container');
        const cameraPreview = document.getElementById('camera-preview');
        const faceDetectionOverlay = document.getElementById('face-detection-overlay');
        const cameraPermissionRequest = document.getElementById('camera-permission-request');

        // Exam variables
        let examData = null;
        let examId = null;
        let timeLeft = 0;
        let timerInterval = null;
        let cameraStream = null;
        let faceDetectionInterval = null;
        let violations = [];
        let tabSwitchCount = 0;
        let fullscreenExitCount = 0;
        let lastVisibilityChangeTime = Date.now();
        let cameraPermissionGranted = false;

        // Request camera permission when page loads
        document.addEventListener('DOMContentLoaded', () => {
            requestCameraPermission();
        });

        // Request camera permission
        async function requestCameraPermission() {
            try {
                // Just query to trigger permission prompt
                await navigator.mediaDevices.getUserMedia({ video: true });
                cameraPermissionGranted = true;
                cameraPermissionRequest.classList.add('hidden');
            } catch (error) {
                console.log('Camera permission not granted yet:', error);
                // Permission request will show when user clicks "Start Exam"
            }
        }

        // Load face-api.js models
        async function loadFaceDetectionModels() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
        }

        // Initialize face detection
        async function initFaceDetection() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                cameraPermissionGranted = true;
                cameraPreview.srcObject = cameraStream;
                cameraContainer.classList.remove('hidden');
                cameraWarning.classList.add('hidden');
                cameraPermissionRequest.classList.add('hidden');
                
                // Start face detection
                faceDetectionInterval = setInterval(detectFaces, 1000);
            } catch (error) {
                console.error('Error accessing camera:', error);
                cameraWarning.classList.remove('hidden');
                throw error; // Re-throw to handle in startExam
            }
        }

        // Detect faces in camera stream
        async function detectFaces() {
            if (!cameraStream) return;
            
            const displaySize = {
                width: cameraPreview.videoWidth,
                height: cameraPreview.videoHeight
            };
            
            faceapi.matchDimensions(faceDetectionOverlay, displaySize);
            
            const detections = await faceapi.detectAllFaces(
                cameraPreview,
                new faceapi.TinyFaceDetectorOptions()
            ).withFaceLandmarks();
            
            // Clear previous drawings
            const context = faceDetectionOverlay.getContext('2d');
            context.clearRect(0, 0, faceDetectionOverlay.width, faceDetectionOverlay.height);
            
            // Draw new detections
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            faceapi.draw.drawDetections(faceDetectionOverlay, resizedDetections);
            faceapi.draw.drawFaceLandmarks(faceDetectionOverlay, resizedDetections);
            
            // Check for violations
            if (detections.length === 0) {
                // No face detected
                recordViolation('no_face', 'Không có khuôn mặt nào được phát hiện trong camera');
            } else if (detections.length > 1) {
                // Multiple faces detected
                recordViolation('multiple_faces', `Phát hiện ${detections.length} khuôn mặt trong camera`);
            }
        }

        // Record a violation
        function recordViolation(type, details) {
            // Check if similar violation was recorded recently (within 5 seconds)
            const now = Date.now();
            const recentViolation = violations.find(v => 
                v.type === type && 
                (now - v.timestamp) < 5000
            );
            
            if (recentViolation) return;
            
            // Capture screenshot
            captureScreenshot().then(screenshot => {
                const violation = {
                    type,
                    details,
                    timestamp: now,
                    screenshot,
                    examId,
                    studentId: auth.currentUser?.uid || 'anonymous',
                    teacherId: examData?.createdBy || null
                };
                
                violations.push(violation);
                
                // Save to Firestore if exam is in progress
                if (examId) {
                    db.collection('violations').add({
                        ...violation,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error('Error saving violation:', error);
                    });
                }
            });
        }

        // Capture screenshot
        function captureScreenshot() {
            return new Promise((resolve) => {
                if (!cameraStream) {
                    resolve(null);
                    return;
                }
                
                const canvas = document.createElement('canvas');
                canvas.width = cameraPreview.videoWidth;
                canvas.height = cameraPreview.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);
                
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            });
        }

        // Enter fullscreen mode
        function enterFullscreen() {
            if (!document.fullscreenElement) {
                return document.documentElement.requestFullscreen()
                    .then(() => {
                        console.log('Entered fullscreen successfully');
                        return true;
                    })
                    .catch(err => {
                        console.error('Error attempting to enable fullscreen:', err);
                        recordViolation('fullscreen_denied', 'Người dùng từ chối chế độ toàn màn hình');
                        return false;
                    });
            }
            return Promise.resolve(true);
        }

        // Check fullscreen state
        function checkFullscreen() {
            if (!document.fullscreenElement) {
                fullscreenExitCount++;
                examContainer.classList.add('blurred');
                fullscreenWarning.classList.remove('hidden');
                recordViolation('fullscreen_exit', `Thoát chế độ toàn màn hình lần thứ ${fullscreenExitCount}`);
            } else {
                examContainer.classList.remove('blurred');
                fullscreenWarning.classList.add('hidden');
            }
        }

        // Check tab visibility
        function handleVisibilityChange() {
            if (document.hidden) {
                const now = Date.now();
                if (now - lastVisibilityChangeTime > 1000) { // Prevent multiple events in short time
                    tabSwitchCount++;
                    recordViolation('tab_switch', `Chuyển tab trình duyệt lần thứ ${tabSwitchCount}`);
                }
                lastVisibilityChangeTime = now;
            }
        }

        // Start exam timer
        function startTimer(minutes) {
            timeLeft = minutes * 60;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
            }, 1000);
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color when time is running out
            if (timeLeft <= 300) { // 5 minutes or less
                timer.classList.add('bg-red-600');
                timer.classList.remove('bg-indigo-800');
            }
        }

        // Load exam questions
        function loadExamQuestions() {
            questionsContainer.innerHTML = '';
            
            examData.questions.forEach((question, index) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'question-block bg-gray-50 p-4 rounded-lg border border-gray-200';
                
                if (question.type === 'mcq') {
                    questionElement.innerHTML = `
                        <h3 class="text-lg font-medium mb-3">Câu ${index + 1}: ${question.question}</h3>
                        <div class="space-y-2">
                            ${question.options.map((option, i) => `
                                <label class="flex items-center">
                                    <input type="radio" name="q${index}" value="${i}" class="mr-2">
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                } else if (question.type === 'tf') {
                    questionElement.innerHTML = `
                        <h3 class="text-lg font-medium mb-3">Câu ${index + 1}: ${question.question}</h3>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="q${index}" value="true" class="mr-2">
                                <span>Đúng</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="q${index}" value="false" class="mr-2">
                                <span>Sai</span>
                            </label>
                        </div>
                    `;
                } else if (question.type === 'sa') {
                    questionElement.innerHTML = `
                        <h3 class="text-lg font-medium mb-3">Câu ${index + 1}: ${question.question}</h3>
                        <input type="text" name="q${index}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    `;
                } else if (question.type === 'essay') {
                    questionElement.innerHTML = `
                        <h3 class="text-lg font-medium mb-3">Câu ${index + 1}: ${question.question}</h3>
                        <textarea name="q${index}" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="4"></textarea>
                    `;
                }
                
                questionsContainer.appendChild(questionElement);
            });
        }

        // Submit exam
        function submitExam() {
            clearInterval(timerInterval);
            clearInterval(faceDetectionInterval);
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraContainer.classList.add('hidden');
            }
            
            // Remove event listeners
            document.removeEventListener('fullscreenchange', checkFullscreen);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            
            // Collect answers
            const answers = [];
            examData.questions.forEach((question, index) => {
                const answerElement = document.querySelector(`input[name="q${index}"]:checked, textarea[name="q${index}"], input[name="q${index}"]`);
                answers.push({
                    question: question.question,
                    answer: answerElement ? answerElement.value : '',
                    correctAnswer: question.correctOption || question.correctAnswer || ''
                });
            });
            
            // Calculate score (simple implementation)
            const score = answers.reduce((total, answer, index) => {
                const question = examData.questions[index];
                if (!answer.answer) return total;
                
                if (question.type === 'mcq' || question.type === 'tf' || question.type === 'sa') {
                    if (answer.answer === (question.correctOption || question.correctAnswer)) {
                        return total + 1;
                    }
                }
                return total;
            }, 0);
            
            const totalQuestions = examData.questions.length;
            const percentage = Math.round((score / totalQuestions) * 100);
            
            // Save results to Firestore if user is logged in
            if (auth.currentUser) {
                db.collection('exam_results').add({
                    examId,
                    studentId: auth.currentUser.uid,
                    answers,
                    score,
                    totalQuestions,
                    percentage,
                    violations,
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    showExamResult(score, totalQuestions, percentage);
                }).catch(error => {
                    console.error('Error saving exam results:', error);
                    showExamResult(score, totalQuestions, percentage);
                });
            } else {
                showExamResult(score, totalQuestions, percentage);
            }
        }

        // Show exam result
        function showExamResult(score, totalQuestions, percentage) {
            examContent.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">Hoàn thành bài thi</h2>
                    <p class="text-lg mb-6">Bạn đã hoàn thành bài thi <span class="font-bold">${examData.name}</span></p>
                    
                    <div class="bg-gray-50 p-6 rounded-lg inline-block text-left max-w-md mx-auto">
                        <h3 class="text-xl font-bold mb-4 text-center">Kết quả</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>Số câu đúng:</span>
                                <span class="font-bold">${score}/${totalQuestions}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tỉ lệ đúng:</span>
                                <span class="font-bold">${percentage}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Số lần vi phạm:</span>
                                <span class="font-bold">${violations.length}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <a href="index.html" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 inline-block">
                            Quay về trang chủ
                        </a>
                    </div>
                </div>
            `;
        }

        // Start exam process
        async function startExam() {
            const examCode = examCodeInput.value.trim();
            
            if (!examCode) {
                alert('Vui lòng nhập mã dự thi');
                return;
            }
            
            try {
                // 1. Load face detection models
                await loadFaceDetectionModels();
                
                // 2. Initialize camera and face detection
                await initFaceDetection();
                
                // 3. Find exam by code
                const examsQuery = db.collection('exams').where('code', '==', examCode).limit(1);
                const querySnapshot = await examsQuery.get();
                
                if (querySnapshot.empty) {
                    alert('Mã dự thi không hợp lệ');
                    return;
                }
                
                querySnapshot.forEach(doc => {
                    examData = doc.data();
                    examId = doc.id;
                    
                    // 4. Update UI
                    examName.textContent = examData.name;
                    examCodeSection.classList.add('hidden');
                    examContent.classList.remove('hidden');
                    submitExamBtn.classList.remove('hidden');
                    submitExamBottomBtn.classList.remove('hidden');
                    
                    // 5. Load questions
                    loadExamQuestions();
                    
                    // 6. Start timer
                    startTimer(examData.time);
                    
                    // 7. Enter fullscreen mode
                    const fullscreenSuccess = await enterFullscreen();
                    if (!fullscreenSuccess) {
                        alert('Bạn cần cho phép chế độ toàn màn hình để tiếp tục làm bài');
                        return;
                    }
                    
                    // 8. Set up event listeners for fullscreen and visibility changes
                    document.addEventListener('fullscreenchange', checkFullscreen);
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                });
            } catch (error) {
                console.error('Error starting exam:', error);
                
                if (error.name === 'NotAllowedError') {
                    alert('Bạn cần cấp quyền truy cập camera để tham gia thi');
                    cameraWarning.classList.remove('hidden');
                } else {
                    alert('Có lỗi xảy ra khi bắt đầu bài thi: ' + error.message);
                }
            }
        }

        // Event listeners
        returnFullscreenBtn.addEventListener('click', () => {
            enterFullscreen();
        });

        checkCameraBtn.addEventListener('click', () => {
            initFaceDetection().catch(error => {
                console.error('Error initializing camera:', error);
            });
        });

        startExamBtn.addEventListener('click', () => {
            startExam().catch(error => {
                console.error('Error in start exam process:', error);
            });
        });

        submitExamBtn.addEventListener('click', submitExam);
        submitExamBottomBtn.addEventListener('click', submitExam);

        // Check if user is logged in (optional)
        auth.onAuthStateChanged(user => {
            // You can use this to personalize the experience
            // For this demo, we allow anonymous users to take exams
        });

        // Initialize face detection models when page loads
        loadFaceDetectionModels().catch(error => {
            console.error('Error loading face detection models:', error);
        });
    </script>
</body>
</html>
